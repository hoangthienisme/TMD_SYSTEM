@model List<TMD.Models.User>
@{
    ViewData["Title"] = "Quản lý người dùng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/css/tasklist-ad.css" rel="stylesheet" />
<link href="~/css/user-management.css" rel="stylesheet" />

<div class="tm-container">
    <!-- PAGE HEADER -->
    <div class="tm-page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="tm-page-title">
                    <i class="fas fa-users me-2"></i> Quản lý người dùng
                </h2>
                <p class="tm-page-subtitle">Danh sách tất cả người dùng và công việc của họ</p>
            </div>
            <a href="/Account/Register" class="tm-btn-create btn btn-primary">
                <i class="fas fa-user-plus me-2"></i> Tạo người dùng mới
            </a>
        </div>
    </div>

    <!-- STATISTICS CARDS -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="tm-stats-card tm-stats-primary">
                <div class="tm-stats-icon"><i class="fas fa-users"></i></div>
                <div class="tm-stats-content">
                    <div class="tm-stats-label">Tổng người dùng</div>
                    <div class="tm-stats-value">@Model.Count</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="tm-stats-card tm-stats-success">
                <div class="tm-stats-icon"><i class="fas fa-user-check"></i></div>
                <div class="tm-stats-content">
                    <div class="tm-stats-label">Đang hoạt động</div>
                    <div class="tm-stats-value">@Model.Count(u => u.IsActive == true)</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="tm-stats-card tm-stats-warning">
                <div class="tm-stats-icon"><i class="fas fa-crown"></i></div>
                <div class="tm-stats-content">
                    <div class="tm-stats-label">Admin</div>
                    <div class="tm-stats-value">@Model.Count(u => u.Role?.RoleName == "Admin")</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="tm-stats-card tm-stats-danger">
                <div class="tm-stats-icon"><i class="fas fa-user-slash"></i></div>
                <div class="tm-stats-content">
                    <div class="tm-stats-label">Vô hiệu hóa</div>
                    <div class="tm-stats-value">@Model.Count(u => u.IsActive == false)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- FILTER & SEARCH -->
    <div class="tm-card mb-4">
        <div class="tm-um-filters-header">
            <h6><i class="fas fa-filter me-2"></i> Bộ lọc và tìm kiếm</h6>
        </div>
        <div class="tm-card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="tm-form-label"><i class="fas fa-search me-1"></i> Tìm kiếm</label>
                    <div class="tm-um-search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" class="tm-form-control" placeholder="Tên, username, email...">
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="tm-form-label"><i class="fas fa-building me-1"></i> Phòng ban</label>
                    <select id="deptFilter" class="tm-form-control">
                        <option value="">Tất cả</option>
                        @foreach (var dept in Model.Select(u => u.Department).Distinct().Where(d => d != null))
                        {
                            <option value="@dept.DepartmentId">@dept.DepartmentName</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="tm-form-label"><i class="fas fa-user-tag me-1"></i> Vai trò</label>
                    <select id="roleFilter" class="tm-form-control">
                        <option value="">Tất cả</option>
                        <option value="Admin">Admin</option>
                        <option value="Staff">Staff</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="tm-form-label"><i class="fas fa-toggle-on me-1"></i> Trạng thái</label>
                    <select id="statusFilter" class="tm-form-control">
                        <option value="">Tất cả</option>
                        <option value="active">Hoạt động</option>
                        <option value="inactive">Vô hiệu hóa</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                        <i class="fas fa-redo me-1"></i> Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- USER TABLE -->
    <div class="tm-card">
        <div class="tm-card-header">
            <h5><i class="fas fa-table me-2"></i> Danh sách người dùng (<span id="showingCount">@Model.Count</span>/<span id="totalCount">@Model.Count</span>)</h5>
        </div>
        <div class="tm-card-body tm-card-body-table">
            <div class="table-responsive">
                <table class="tm-table" id="userTable">
                    <thead>
                        <tr>
                            <th width="5%">STT</th>
                            <th width="20%">Người dùng</th>
                            <th width="12%">Username</th>
                            <th width="13%">Email</th>
                            <th width="12%">Phòng ban</th>
                            <th width="10%">Vai trò</th>
                            <th width="10%">Trạng thái</th>
                            <th width="10%">Đăng nhập cuối</th>
                            <th width="13%">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.Count; i++)
                        {
                            var user = Model[i];
                            <tr data-role="@user.Role?.RoleName"
                                data-status="@(user.IsActive == true ? "active" : "inactive")"
                                data-dept="@user.DepartmentId"
                                data-fullname="@user.FullName?.ToLower()"
                                data-username="@user.Username?.ToLower()"
                                data-email="@user.Email?.ToLower()"
                                data-phone="@user.PhoneNumber">
                                <td class="text-center fw-bold">@(i + 1)</td>
                                <td>
                                    <div class="tm-um-user-info">
                                        <div class="tm-um-user-avatar">
                                            @if (!string.IsNullOrEmpty(user.Avatar))
                                            {
                                                <img src="@user.Avatar" alt="@user.FullName"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                <span style="display:none;">@user.FullName?.Substring(0, 1)</span>
                                            }
                                            else
                                            {
                                                <span>@user.FullName?.Substring(0, 1)</span>
                                            }
                                        </div>
                                        <div class="tm-um-user-details">
                                            <div class="tm-um-user-name">@user.FullName</div>
                                            <small class="tm-text-muted">
                                                <i class="fas fa-phone-alt me-1"></i>@(user.PhoneNumber ?? "N/A")
                                            </small>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="tm-um-username-badge">@@@user.Username</span></td>
                                <td>
                                    @if (!string.IsNullOrEmpty(user.Email))
                                    {
                                        <span class="tm-um-email"><i class="fas fa-envelope me-1"></i>@user.Email</span>
                                    }
                                    else
                                    {
                                        <span class="tm-text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (user.Department != null)
                                    {
                                        <span class="tm-badge tm-badge-info">
                                            <i class="fas fa-building me-1"></i>@user.Department.DepartmentName
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="tm-text-muted">Chưa phân công</span>
                                    }
                                </td>
                                <td>
                                    @if (user.Role?.RoleName == "Admin")
                                    {
                                        <span class="tm-badge tm-um-badge-admin">
                                            <i class="fas fa-crown me-1"></i> Admin
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="tm-badge tm-badge-secondary">
                                            <i class="fas fa-user me-1"></i> Staff
                                        </span>
                                    }
                                </td>
                                <td>
                                    @if (user.IsActive == true)
                                    {
                                        <span class="tm-badge tm-badge-success">
                                            <i class="fas fa-check-circle me-1"></i> Hoạt động
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="tm-badge tm-badge-danger">
                                            <i class="fas fa-ban me-1"></i> Vô hiệu
                                        </span>
                                    }
                                </td>
                                <td>
                                    @if (user.LastLoginAt.HasValue)
                                    {
                                        <div class="tm-um-last-login">
                                            <i class="far fa-clock me-1"></i>
                                            <small>@user.LastLoginAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="tm-text-muted"><small>Chưa đăng nhập</small></span>
                                    }
                                </td>
                                <td>
                                    <div class="tm-action-buttons">
                                        <button class="tm-btn-action tm-btn-action-success btn-view-detail"
                                                data-id="@user.UserId"
                                                data-name="@user.FullName"
                                                title="Xem chi tiết người dùng">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="tm-btn-action tm-btn-action-warning"
                                                onclick="toggleUserStatus(@user.UserId, '@user.FullName', @(user.IsActive.ToString().ToLower()))"
                                                title="@(user.IsActive == true ? "Vô hiệu hóa" : "Kích hoạt")">
                                            <i class="fas fa-@(user.IsActive == true ? "ban" : "check")"></i>
                                        </button>
                                        <a href="/Admin/ResetUserPassword/@user.UserId"
                                           class="tm-btn-action tm-btn-action-info"
                                           title="Reset mật khẩu">
                                            <i class="fas fa-key"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Chi Tiết Người Dùng -->
<div class="modal fade tm-modal" id="userDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="tm-modal-header">
                <h5 class="tm-modal-title">
                    <i class="fas fa-user-circle me-2"></i> Chi tiết người dùng
                </h5>
                <button type="button" class="tm-btn-close" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="tm-modal-body" id="detailContent" style="max-height: 600px; overflow-y: auto;">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                    <p class="mt-3 text-muted">Đang tải dữ liệu...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .tm-um-user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            flex-shrink: 0;
        }

        .tm-um-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tm-detail-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .tm-detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .tm-detail-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
        }

        .tm-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.95rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .tm-detail-row:last-child {
            border-bottom: none;
        }

        .tm-detail-label {
            color: #6c757d;
            font-weight: 500;
        }

        .tm-detail-value {
            color: #2c3e50;
            font-weight: 600;
        }

        .tm-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
        }

        .tm-stat-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border-left: 3px solid #5e72e4;
        }

        .tm-stat-box.success { border-left-color: #2dce89; }
        .tm-stat-box.warning { border-left-color: #fb6340; }
        .tm-stat-box.danger { border-left-color: #f5365c; }

        .tm-stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .tm-stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 3px;
        }
    </style>

    <script>
        const searchInput = document.getElementById('searchInput');
        const roleFilter = document.getElementById('roleFilter');
        const statusFilter = document.getElementById('statusFilter');
        const deptFilter = document.getElementById('deptFilter');
        const tableRows = document.querySelectorAll('#userTable tbody tr');

        function filterTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedRole = roleFilter.value;
            const selectedStatus = statusFilter.value;
            const selectedDept = deptFilter.value;
            let visibleCount = 0;

            tableRows.forEach(row => {
                const fullname = row.getAttribute('data-fullname') || '';
                const username = row.getAttribute('data-username') || '';
                const email = row.getAttribute('data-email') || '';
                const phone = row.getAttribute('data-phone') || '';
                const role = row.getAttribute('data-role');
                const status = row.getAttribute('data-status');
                const dept = row.getAttribute('data-dept');

                const matchSearch = fullname.includes(searchTerm) || username.includes(searchTerm) || 
                                  email.includes(searchTerm) || phone.includes(searchTerm);
                const matchRole = !selectedRole || role === selectedRole;
                const matchStatus = !selectedStatus || status === selectedStatus;
                const matchDept = !selectedDept || dept === selectedDept;

                if (matchSearch && matchRole && matchStatus && matchDept) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            document.getElementById('showingCount').textContent = visibleCount;
        }

        searchInput.addEventListener('input', filterTable);
        roleFilter.addEventListener('change', filterTable);
        statusFilter.addEventListener('change', filterTable);
        deptFilter.addEventListener('change', filterTable);

        function resetFilters() {
            searchInput.value = '';
            roleFilter.value = '';
            statusFilter.value = '';
            deptFilter.value = '';
            filterTable();
        }

        async function toggleUserStatus(userId, fullName, currentStatus) {
            const action = currentStatus ? 'vô hiệu hóa' : 'kích hoạt';

            const result = await Swal.fire({
                title: `${action.charAt(0).toUpperCase() + action.slice(1)} tài khoản?`,
                text: `Bạn có chắc muốn ${action} tài khoản của ${fullName}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: currentStatus ? '#f5365c' : '#2dce89',
                cancelButtonColor: '#8898aa',
                confirmButtonText: `Có, ${action}!`,
                cancelButtonText: 'Hủy'
            });

            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Đang xử lý...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                try {
                    const response = await fetch('/Admin/ToggleUserStatus', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: userId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công!',
                            text: data.message,
                            confirmButtonColor: '#5e72e4'
                        }).then(() => location.reload());
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Thất bại',
                            text: data.message,
                            confirmButtonColor: '#f5365c'
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: 'Có lỗi xảy ra.',
                        confirmButtonColor: '#f5365c'
                    });
                }
            }
        }

        document.querySelectorAll('.btn-view-detail').forEach(btn => {
            btn.addEventListener('click', async function() {
                const userId = this.dataset.id;
                const userName = this.dataset.name;

                const modal = document.getElementById('userDetailModal');
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();

                document.getElementById('detailContent').innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">Đang tải dữ liệu...</p>
                    </div>
                `;

                try {
                    const response = await fetch(`/Admin/GetUserDetail?userId=${userId}`);
                    const data = await response.json();

                    if (!data.success) {
                        document.getElementById('detailContent').innerHTML = `
                            <div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>${data.message}</div>
                        `;
                        return;
                    }

                    const u = data.user;
                    const t = data.tasks;
                    const a = data.attendance;
                    const s = data.salary;
                    const r = data.requests;

                    const html = `
                        <div class="tm-detail-section">
                            <div class="tm-detail-section-title"><i class="fas fa-user"></i> Thông tin cá nhân</div>
                            <div class="tm-detail-row"><span class="tm-detail-label">Tên:</span><span class="tm-detail-value">${u.fullName}</span></div>
                            <div class="tm-detail-row"><span class="tm-detail-label">Username:</span><span class="tm-detail-value">${u.username}</span></div>
                            <div class="tm-detail-row"><span class="tm-detail-label">Email:</span><span class="tm-detail-value">${u.email || 'N/A'}</span></div>
                            <div class="tm-detail-row"><span class="tm-detail-label">Phòng ban:</span><span class="tm-detail-value">${u.departmentName}</span></div>
                            <div class="tm-detail-row"><span class="tm-detail-label">Trạng thái:</span><span class="tm-detail-value">${u.isActive ? '<span class="badge bg-success">Hoạt động</span>' : '<span class="badge bg-danger">Vô hiệu</span>'}</span></div>
                        </div>

                        <div class="tm-detail-section">
                            <div class="tm-detail-section-title"><i class="fas fa-tasks"></i> Công việc</div>
                            <div class="tm-stats-grid">
                                <div class="tm-stat-box"><div class="tm-stat-value">${t.total}</div><div class="tm-stat-label">Tổng</div></div>
                                <div class="tm-stat-box success"><div class="tm-stat-value">${t.completed}</div><div class="tm-stat-label">Hoàn thành</div></div>
                                <div class="tm-stat-box warning"><div class="tm-stat-value">${t.inProgress}</div><div class="tm-stat-label">Đang làm</div></div>
                                <div class="tm-stat-box danger"><div class="tm-stat-value">${t.overdue}</div><div class="tm-stat-label">Quá hạn</div></div>
                            </div>
                            <div class="progress mt-2">
                                <div class="progress-bar" style="width: ${t.completionRate}%">${t.completionRate}%</div>
                            </div>
                        </div>

                        <div class="tm-detail-section">
                            <div class="tm-detail-section-title"><i class="fas fa-calendar-check"></i> Chấm công (tháng này)</div>
                            <div class="tm-stats-grid">
                                <div class="tm-stat-box"><div class="tm-stat-value">${a.totalWorkDays}</div><div class="tm-stat-label">Ngày làm</div></div>
                                <div class="tm-stat-box success"><div class="tm-stat-value">${a.onTimeDays}</div><div class="tm-stat-label">Đúng giờ</div></div>
                                <div class="tm-stat-box danger"><div class="tm-stat-value">${a.lateDays}</div><div class="tm-stat-label">Muộn</div></div>
                            </div>
                            <div class="tm-detail-row"><span class="tm-detail-label">Giờ làm:</span><span class="tm-detail-value">${a.totalWorkHours} h</span></div>
                            <div class="tm-detail-row"><span class="tm-detail-label">Tăng ca đã duyệt:</span><span class="tm-detail-value">${a.approvedOvertimeHours} h</span></div>
                        </div>

                        <div class="tm-detail-section">
                            <div class="tm-detail-section-title"><i class="fas fa-money-bill"></i> Lương (tháng này)</div>
                            <div class="tm-detail-row"><span class="tm-detail-label">Lương cơ bản:</span><span class="tm-detail-value">${s.baseSalary?.toLocaleString('vi-VN')} ₫</span></div>
                            <div class="tm-detail-row"><span class="tm-detail-label">Lương giờ làm:</span><span class="tm-detail-value">${s.workHoursSalary?.toLocaleString('vi-VN')} ₫</span></div>
                            <div class="tm-detail-row"><span class="tm-detail-label">Lương tăng ca:</span><span class="tm-detail-value">${s.overtimeSalary?.toLocaleString('vi-VN')} ₫</span></div>
                            <div class="tm-detail-row"><span class="tm-detail-label">Khấu trừ:</span><span class="tm-detail-value text-danger">${s.totalDeduction?.toLocaleString('vi-VN')} ₫</span></div>
                            <div class="tm-detail-row" style="border-top: 2px solid #e9ecef; padding-top: 12px;"><span class="tm-detail-label"><strong>Lương dự kiến:</strong></span><span class="tm-detail-value text-success" style="font-size: 1.1rem;">${s.estimatedSalary?.toLocaleString('vi-VN')} ₫</span></div>
                        </div>

                        <div class="tm-detail-section">
                            <div class="tm-detail-section-title"><i class="fas fa-file-alt"></i> Đơn xin</div>
                            <div class="tm-stats-grid">
                                <div class="tm-stat-box"><div class="tm-stat-value">${r.approvedLeaves}</div><div class="tm-stat-label">Nghỉ đã duyệt</div></div>
                                <div class="tm-stat-box warning"><div class="tm-stat-value">${r.pendingLeaves}</div><div class="tm-stat-label">Đơn chờ</div></div>
                                <div class="tm-stat-box success"><div class="tm-stat-value">${r.approvedOvertimes}</div><div class="tm-stat-label">Tăng ca đã duyệt</div></div>
                            </div>
                        </div>
                    `;

                    document.getElementById('detailContent').innerHTML = html;
                } catch (error) {
                    document.getElementById('detailContent').innerHTML = `
                        <div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Lỗi: ${error.message}</div>
                    `;
                }
            });
        });
    </script>
}