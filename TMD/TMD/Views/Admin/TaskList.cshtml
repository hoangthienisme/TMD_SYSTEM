@model List<TMD.Models.Task>
@{
    ViewData["Title"] = "Quản lý Task";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/css/tasklist-ad.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">

<div class="container-fluid px-4 py-4 tm-container">
    <!-- Header Section -->
    <div class="tm-page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="tm-page-title">
                    <i class="fas fa-tasks me-2"></i> Quản lý Task
                </h1>
                <p class="tm-page-subtitle">Theo dõi và quản lý tất cả các task của hệ thống</p>
            </div>
            <a asp-action="CreateTask" class="btn btn-primary tm-btn-create">
                <i class="fas fa-plus me-2"></i> Tạo Task mới
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="tm-stats-card tm-stats-primary">
                <div class="tm-stats-icon"><i class="fas fa-tasks"></i></div>
                <div class="tm-stats-content">
                    <div class="tm-stats-label">Tổng Task</div>
                    <div class="tm-stats-value">@ViewBag.TotalTasks</div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="tm-stats-card tm-stats-info">
                <div class="tm-stats-icon"><i class="fas fa-inbox"></i></div>
                <div class="tm-stats-content">
                    <div class="tm-stats-label">Chưa bắt đầu</div>
                    <div class="tm-stats-value">@ViewBag.TodoTasks</div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="tm-stats-card tm-stats-warning">
                <div class="tm-stats-icon"><i class="fas fa-spinner"></i></div>
                <div class="tm-stats-content">
                    <div class="tm-stats-label">Đang làm</div>
                    <div class="tm-stats-value">@ViewBag.InProgressTasks</div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="tm-stats-card tm-stats-success">
                <div class="tm-stats-icon"><i class="fas fa-check-circle"></i></div>
                <div class="tm-stats-content">
                    <div class="tm-stats-label">Hoàn thành</div>
                    <div class="tm-stats-value">@ViewBag.CompletedTasks</div>
                </div>
                <div class="tm-stats-trend">
                    <span class="tm-completion-rate">@ViewBag.TaskCompletionRate%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Table Card -->
    <div class="tm-card">
        <div class="tm-card-header">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i> Danh sách Task</h5>
        </div>
        <div class="tm-card-body-table">
            <div class="table-responsive">
                <table class="tm-table" id="taskTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th width="5%">ID</th>
                            <th width="20%">Tên Task</th>
                            <th width="10%">Platform</th>
                            <th width="12%">Deadline</th>
                            <th width="8%">Priority</th>
                            <th width="28%">Người làm & Trạng thái</th>
                            <th width="7%">Active</th>
                            <th width="10%">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var task in Model)
                        {
                            var totalAssigned = task.UserTasks.Count;
                            var completedCount = task.UserTasks.Count(ut => ut.Status == "Completed");
                            var isTaskCompleted = totalAssigned > 0 && completedCount == totalAssigned;
                            var isOverdue = task.Deadline.HasValue && !isTaskCompleted && DateTime.Now > task.Deadline.Value;
                            var rowClass = isOverdue ? "tm-row-overdue" : "";

                            <tr class="@rowClass" data-task-id="@task.TaskId">
                                <td class="text-center">
                                    <span class="tm-task-id">@task.TaskId</span>
                                </td>
                                <td>
                                    <div class="tm-task-info">
                                        <div class="tm-task-icon">
                                            <i class="fas fa-clipboard-list"></i>
                                        </div>
                                        <div class="tm-task-details">
                                            <div class="tm-task-name">@task.TaskName</div>
                                            @if (!string.IsNullOrEmpty(task.Description))
                                            {
                                                <div class="tm-task-description">@task.Description</div>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(task.Platform))
                                    {
                                        <span class="tm-badge tm-badge-info">
                                            <i class="fas fa-globe me-1"></i>@task.Platform
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="tm-text-muted">—</span>
                                    }
                                </td>
                                <td>
                                    @if (task.Deadline.HasValue)
                                    {
                                        <div class="tm-deadline-wrapper @(isOverdue ? "is-overdue" : "")">
                                            <div class="tm-deadline-date">
                                                <i class="far fa-calendar-alt me-1"></i>
                                                @task.Deadline.Value.ToString("dd/MM/yyyy")
                                            </div>
                                            <div class="tm-deadline-time">@task.Deadline.Value.ToString("HH:mm")</div>
                                            @if (isOverdue)
                                            {
                                                <span class="tm-badge tm-badge-danger mt-1">
                                                    <i class="fas fa-exclamation-circle me-1"></i>Quá hạn
                                                </span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="tm-text-muted">Không có</span>
                                    }
                                </td>
                                <td>
                                    @{
                                        var priorityClass = task.Priority switch
                                        {
                                            "High" => "tm-badge-danger",
                                            "Medium" => "tm-badge-warning",
                                            "Low" => "tm-badge-success",
                                            _ => "tm-badge-secondary"
                                        };
                                    }
                                    <span class="tm-badge @priorityClass">
                                        @task.Priority
                                    </span>
                                </td>

                                <td>
                                    @if (totalAssigned > 0)
                                    {
                                        <div class="tm-user-status-list">
                                            @foreach (var ut in task.UserTasks.Take(3))
                                            {
                                                var statusClass = ut.Status switch
                                                {
                                                    "TODO" => "secondary",
                                                    "InProgress" => "warning",
                                                    "Completed" => "success",
                                                    _ => "secondary"
                                                };

                                                <div class="tm-user-status-item">
                                                    <div class="tm-user-avatar-wrapper">
                                                        @if (!string.IsNullOrEmpty(ut.User.Avatar) && ut.User.Avatar != "/images/default-avatar.png")
                                                        {
                                                            <img src="@ut.User.Avatar"
                                                                 alt="@ut.User.FullName"
                                                                 class="tm-user-avatar-sm"
                                                                 style="object-fit: cover; width: 32px; height: 32px;"
                                                                 onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                                                            <div class="tm-user-avatar-placeholder-sm rounded-circle"
                                                                 style="display:none;width:32px;height:32px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0;">
                                                                @ut.User.FullName.Substring(0, 1).ToUpper()
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="tm-user-avatar-placeholder-sm rounded-circle"
                                                                 style="width:32px;height:32px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0;">
                                                                @ut.User.FullName.Substring(0, 1).ToUpper()
                                                            </div>
                                                        }
                                                        <span class="tm-user-name">@ut.User.FullName</span>
                                                    </div>
                                                    <span class="tm-badge tm-badge-@statusClass tm-badge-sm">
                                                        @(ut.Status switch { "TODO" => "Chưa bắt đầu", "InProgress" => "Đang làm", "Completed" => "Hoàn thành", _ => "Chưa bắt đầu" })
                                                    </span>
                                                </div>
                                            }
                                            @if (task.UserTasks.Count > 3)
                                            {
                                                <div class="tm-text-muted tm-text-sm">
                                                    +@(task.UserTasks.Count - 3) người khác
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="tm-text-muted">Chưa assign</span>
                                    }
                                </td>

                                <td>
                                    <span class="tm-badge @(task.IsActive == true ? "tm-badge-success" : "tm-badge-secondary")">
                                        @(task.IsActive == true ? "Có" : "Không")
                                    </span>
                                </td>
                                <td>
                                    <div class="tm-action-buttons">
                                        <button type="button" class="tm-btn-action tm-btn-action-info btn-view"
                                                data-id="@task.TaskId" title="Xem chi tiết">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        @if (task.IsActive == true)
                                        {
                                            <a asp-action="EditTask" asp-route-id="@task.TaskId"
                                               class="tm-btn-action tm-btn-action-warning" title="Chỉnh sửa">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="tm-btn-action tm-btn-action-danger btn-delete"
                                                    data-id="@task.TaskId" data-name="@task.TaskName" title="Ẩn">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="button" class="tm-btn-action tm-btn-action-success btn-restore"
                                                    data-id="@task.TaskId" data-name="@task.TaskName" title="Khôi phục">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Task Detail Modal -->
<div class="modal fade tm-modal" id="taskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="tm-modal-header">
                <h5 class="tm-modal-title">
                    <i class="fas fa-info-circle me-2"></i> Chi tiết Task
                </h5>
                <button type="button" class="tm-btn-close" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="tm-modal-body" id="taskDetailContent">
                <div class="tm-loading text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 tm-text-muted">Đang tải...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ✅ INIT DATATABLE
            if (typeof $ !== 'undefined' && $.fn.DataTable) {
                $('#taskTable').DataTable({
                    language: { url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json' },
                    order: [[0, 'desc']],
                    pageLength: 25,
                    responsive: true
                });
            }

            // ✅ VIEW BUTTON
            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    viewTaskDetail(this.dataset.id);
                });
            });

            // ✅ DELETE & RESTORE BUTTONS
            document.querySelectorAll('.btn-delete, .btn-restore').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const isDelete = this.classList.contains('btn-delete');
                    const taskId = this.dataset.id;
                    const taskName = this.dataset.name;
                    const msg = isDelete ? `Ẩn task "${taskName}"?` : `Khôi phục task "${taskName}"?`;

                    if (confirm(`Bạn có chắc muốn ${msg}`)) {
                        isDelete ? deleteTask(taskId) : restoreTask(taskId);
                    }
                });
            });

            function showToast(message, type = 'info') {
                const toastClass = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
                const toast = document.createElement('div');
                toast.className = toastClass;
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                toast.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.remove();
                }, 4000);
            }

                   // HÀM viewTaskDetail FULL - Copy toàn bộ hàm này vào TaskList.cshtml
        function viewTaskDetail(taskId) {
            const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            const content = document.getElementById('taskDetailContent');
            modal.show();

            fetch(`/Admin/GetTaskDetails?id=${taskId}`)
                .then(r => r.json())
                .then(data => {
                    if (!data || !data.success) {
                        content.innerHTML = `<div class="alert alert-danger">Lỗi: ${data?.message || 'Không thể tải dữ liệu'}</div>`;
                        return;
                    }

                    const t = data.task || {};

                    // ✅ TASK INFO
                    const priorityBg = t.Priority === 'High' ? 'danger' : t.Priority === 'Medium' ? 'warning' : 'success';
                    const statusBg = t.IsActive ? 'success' : 'secondary';

                    // ✅ USER TASKS TABLE - FIX AVATAR
                    let usersHTML = '';
                    if (t.AssignedUsers && t.AssignedUsers.length > 0) {
                        usersHTML = t.AssignedUsers.map(u => {
                            const statusBg = u.StatusClass === 'success' ? 'bg-success' :
                                             u.StatusClass === 'warning' ? 'bg-warning' : 'bg-secondary';

                            // FIX: Avatar display - Kiểm tra có avatar không
                            let avatarHTML = '';
                            if (u.Avatar && u.Avatar !== '/images/default-avatar.png') {
                                // Có avatar thì load, nếu lỗi thì ẩn và hiển thị placeholder
                                avatarHTML = `
                                    <img src="${u.Avatar}"
                                         alt="${u.FullName}"
                                         class="avatar-img"
                                         style="width:36px;height:36px;border-radius:50%;object-fit:cover;margin-right:10px;display:block;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                    <div class="avatar-placeholder"
                                         style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:none;align-items:center;justify-content:center;font-weight:700;margin-right:10px;font-size:14px;flex-shrink:0;">
                                        ${(u.FullName || 'U').substring(0,1).toUpperCase()}
                                    </div>
                                `;
                            } else {
                                // Không có avatar - dùng placeholder
                                avatarHTML = `
                                    <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;margin-right:10px;font-size:14px;flex-shrink:0;">
                                        ${(u.FullName || 'U').substring(0,1).toUpperCase()}
                                    </div>
                                `;
                            }

                            return `
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            ${avatarHTML}
                                            <div>
                                                <div class="fw-bold">${u.FullName || 'N/A'}</div>
                                                <small class="text-muted">${u.DepartmentName || 'N/A'}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge ${statusBg}">${u.StatusText || 'N/A'}</span>
                                    </td>
                                    <td>
                                        ${u.CompletedThisWeek ?? 0}
                                    </td>
                                    <td>
                                        ${u.ReportLink ? `<a href="${u.ReportLink}" target="_blank" class="link-primary text-decoration-none"><i class="fas fa-external-link-alt"></i> Xem</a>` : '<span class="text-muted">—</span>'}
                                    </td>
                                    <td>
                                        <small class="text-muted">${u.UpdatedAtStr || 'N/A'}</small>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        usersHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Chưa có người được giao</td></tr>';
                    }

                    content.innerHTML = `
                        <div class="p-3">
                            <!-- TASK INFO -->
                            <div class="mb-4 pb-3 border-bottom">
                                <h5 class="mb-2">${t.TaskName || 'Không có tên'}</h5>
                                <p class="text-muted mb-3">${t.Description || 'Không có mô tả'}</p>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div>
                                            <small class="text-muted d-block mb-1"><i class="fas fa-globe me-1"></i>Platform</small>
                                            <strong>${t.Platform || '—'}</strong>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div>
                                            <small class="text-muted d-block mb-1"><i class="fas fa-flag me-1"></i>Priority</small>
                                            <span class="badge bg-${priorityBg}">${t.Priority || 'Medium'}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div>
                                            <small class="text-muted d-block mb-1"><i class="far fa-calendar me-1"></i>Deadline</small>
                                            <strong>${t.DeadlineStr || '<span class="text-muted">—</span>'}</strong>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div>
                                            <small class="text-muted d-block mb-1"><i class="fas fa-toggle-on me-1"></i>Status</small>
                                            <span class="badge bg-${statusBg}">${t.IsActive ? 'Hoạt động' : 'Ẩn'}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div>
                                            <small class="text-muted d-block mb-1"><i class="fas fa-bullseye me-1"></i>Target/Week</small>
                                            <strong>${t.TargetPerWeek || '—'}</strong>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div>
                                            <small class="text-muted d-block mb-1"><i class="fas fa-info-circle me-1"></i>Thời gian</small>
                                            <small class="text-muted">
                                                Tạo: ${t.CreatedAtStr || 'N/A'}<br>
                                                Cập nhật: ${t.UpdatedAtStr || 'N/A'}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- USER TASKS -->
                            <div>
                                <h6 class="mb-3"><i class="fas fa-users me-2"></i>Danh sách người làm (${t.AssignedUsers?.length || 0})</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Người làm</th>
                                                <th>Trạng thái</th>
                                                <th>Hoàn thành tuần</th>
                                                <th>Báo cáo</th>
                                                <th>Cập nhật</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${usersHTML}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                })
                .catch(err => {
                    content.innerHTML = '<div class="alert alert-danger">Lỗi tải dữ liệu</div>';
                    console.error(err);
                });
        }

            function deleteTask(taskId) {
                fetch('@Url.Action("DeleteTask", "Admin")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskId: parseInt(taskId) })
                })
                    .then(r => r.json())
                    .then(data => {
                        showToast(data.message, data.success ? 'success' : 'danger');
                        if (data.success) setTimeout(() => location.reload(), 1000);
                    })
                    .catch(() => showToast('Lỗi xảy ra!', 'danger'));
            }

            function restoreTask(taskId) {
                fetch('@Url.Action("ToggleTaskStatus", "Admin")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskId: parseInt(taskId) })
                })
                    .then(r => r.json())
                    .then(data => {
                        showToast(data.message, data.success ? 'success' : 'danger');
                        if (data.success) setTimeout(() => location.reload(), 1000);
                    })
                    .catch(() => showToast('Lỗi xảy ra!', 'danger'));
            }
        });
    </script>

   
}