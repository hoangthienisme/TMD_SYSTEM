@model TMD.Models.Task
@{
    ViewData["Title"] = "Tạo Task mới";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/css/tasklist-ad.css" rel="stylesheet" />

<div class="container-fluid px-4 py-4 tm-container">
    <!-- Header Section -->
    <div class="tm-page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="tm-page-title">
                    <i class="fas fa-plus-circle me-2"></i> Tạo Task mới
                </h1>
                <p class="tm-page-subtitle">Tạo và gán task cho nhân viên của bạn</p>
            </div>
            <a asp-action="TaskList" class="btn btn-secondary tm-btn-back">
                <i class="fas fa-arrow-left me-2"></i> Quay lại
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Main Form -->
        <div class="col-lg-8">
            <div class="tm-card">
                <div class="tm-card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-edit me-2"></i> Thông tin Task
                    </h6>
                </div>
                <div class="tm-card-body">
                    <form id="createTaskForm">
                        <div class="tm-form-group">
                            <label for="taskName" class="tm-form-label">
                                Tên Task <span class="tm-text-danger">*</span>
                            </label>
                            <input type="text" class="form-control tm-form-control tm-form-control-lg" id="taskName"
                                   placeholder="Nhập tên task..." required>
                            <small class="form-text tm-text-muted">
                                <i class="fas fa-info-circle me-1"></i> Tên task phải rõ ràng và dễ hiểu
                            </small>
                        </div>

                        <div class="tm-form-group">
                            <label for="description" class="tm-form-label">Mô tả</label>
                            <textarea class="form-control tm-form-control" id="description" rows="4"
                                      placeholder="Mô tả chi tiết về task..."></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="tm-form-group">
                                    <label for="platform" class="tm-form-label">Platform</label>
                                    <select class="form-control tm-form-control" id="platform">
                                        <option value="">-- Chọn Platform --</option>
                                        <option value="Facebook">📘 Facebook</option>
                                        <option value="Instagram">📷 Instagram</option>
                                        <option value="TikTok">🎵 TikTok</option>
                                        <option value="YouTube">📺 YouTube</option>
                                        <option value="LinkedIn">💼 LinkedIn</option>
                                        <option value="Twitter">🐦 Twitter</option>
                                        <option value="Google Ads">🎯 Google Ads</option>
                                        <option value="Website">🌐 Website</option>
                                        <option value="Other">📌 Khác</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="tm-form-group">
                                    <label for="deadline" class="tm-form-label">Deadline</label>
                                    <input type="datetime-local" class="form-control tm-form-control" id="deadline">
                                </div>
                            </div>
                        </div>

                        <div class="tm-form-group">
                            <label for="priority" class="tm-form-label">Priority</label>
                            <select class="form-control tm-form-control" id="priority">
                                <option value="Low">🟢 Low - Ưu tiên thấp</option>
                                <option value="Medium" selected>🟡 Medium - Ưu tiên trung bình</option>
                                <option value="High">🔴 High - Ưu tiên cao</option>
                            </select>
                        </div>

                        <div class="tm-divider"></div>

                        <div class="tm-form-group">
                            <label class="tm-form-label">
                                <i class="fas fa-users me-2"></i> Gán cho nhân viên
                                <span class="tm-text-muted font-weight-normal">(Chọn nhiều)</span>
                            </label>
                            <div class="tm-card" style="border: 2px solid var(--tm-primary);">
                                <div class="tm-card-body">
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text tm-bg-gradient-primary tm-text-white">
                                                    <i class="fas fa-search"></i>
                                                </span>
                                            </div>
                                            <input type="text" class="form-control tm-form-control" id="searchUsers"
                                                   placeholder="Tìm kiếm nhân viên theo tên hoặc phòng ban...">
                                        </div>
                                    </div>

                                    <div class="custom-control custom-checkbox mb-3 pb-2 border-bottom">
                                        <input type="checkbox" class="custom-control-input" id="selectAll">
                                        <label class="custom-control-label font-weight-bold tm-text-primary" for="selectAll">
                                            <i class="fas fa-check-double me-1"></i> Chọn tất cả
                                        </label>
                                        <span class="tm-badge tm-badge-info float-right" id="selectedCount">0</span>
                                    </div>

                                    <div class="tm-user-list" id="userList">
                                        @if (ViewBag.Users != null)
                                        {
                                            var usersByDept = ((List<TMD.Models.User>)ViewBag.Users)
                                            .GroupBy(u => u.Department?.DepartmentName ?? "Chưa có phòng ban")
                                            .OrderBy(g => g.Key);

                                            foreach (var deptGroup in usersByDept)
                                            {
                                                <div class="tm-dept-group">
                                                    <div class="tm-dept-header">
                                                        <h6 class="tm-dept-title">
                                                            <i class="fas fa-building me-2"></i> @deptGroup.Key
                                                            <span class="tm-badge tm-badge-info ms-2">@deptGroup.Count()</span>
                                                        </h6>
                                                    </div>
                                                    @foreach (var user in deptGroup.OrderBy(u => u.FullName))
                                                    {
                                                        <div class="custom-control custom-checkbox ms-3 tm-user-item"
                                                             data-name="@user.FullName.ToLower()"
                                                             data-dept="@(user.Department?.DepartmentName?.ToLower() ?? "")">
                                                            <input type="checkbox" class="custom-control-input user-checkbox"
                                                                   id="user_@user.UserId" value="@user.UserId">
                                                            <label class="custom-control-label tm-user-label" for="user_@user.UserId">
                                                                <div class="d-flex align-items-center">
                                                                    @if (!string.IsNullOrEmpty(user.Avatar) && user.Avatar != "/images/default-avatar.png")
                                                                    {
                                                                        <!-- Avatar có ảnh -->
                                                                        <img src="@user.Avatar"
                                                                             class="rounded-circle me-2"
                                                                             width="35"
                                                                             height="35"
                                                                             style="object-fit: cover;"
                                                                             onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                                                                        <div class="avatar-placeholder rounded-circle me-2"
                                                                             style="display:none;width:35px;height:35px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;align-items:center;justify-content:center;font-weight:700;font-size:14px;">
                                                                            @user.FullName.Substring(0, 1).ToUpper()
                                                                        </div>
                                                                    }
                                                                    else
                                                                    {
                                                                        <!-- Placeholder chữ cái đầu -->
                                                                        <div class="rounded-circle me-2"
                                                                             style="width:35px;height:35px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;">
                                                                            @user.FullName.Substring(0, 1).ToUpper()
                                                                        </div>
                                                                    }
                                                                    <div>
                                                                        <strong class="d-block">@user.FullName</strong>
                                                                        <small class="tm-text-muted">@user.Username</small>
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tm-divider"></div>

                        <div class="tm-alert tm-alert-info">
                            <i class="fas fa-lightbulb fa-lg"></i>
                            <div>
                                <strong>Lưu ý:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Tên task không được để trống</li>
                                    <li>Có thể gán task cho nhiều nhân viên cùng lúc</li>
                                    <li>Deadline và Platform có thể để trống</li>
                                </ul>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a asp-action="TaskList" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times me-2"></i> Hủy
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg tm-shadow" id="btnSubmit">
                                <i class="fas fa-save me-2"></i> Tạo Task
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Preview Card -->
            <div class="tm-card tm-sticky">
                <div class="tm-card-header tm-bg-gradient-info tm-text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-eye me-2"></i> Xem trước
                    </h6>
                </div>
                <div class="tm-card-body">
                    <div class="tm-preview-section mb-3">
                        <h5 id="previewTaskName" class="tm-text-muted font-weight-bold mb-2">
                            <i class="fas fa-clipboard-list me-1"></i> Tên task...
                        </h5>
                        <p id="previewDescription" class="tm-text-muted small mb-0">Mô tả...</p>
                    </div>

                    <div class="tm-divider"></div>

                    <div class="tm-preview-item mb-3">
                        <small class="tm-text-muted d-block mb-2">
                            <i class="fas fa-globe me-1"></i> Platform
                        </small>
                        <span id="previewPlatform" class="tm-badge tm-badge-secondary">N/A</span>
                    </div>

                    <div class="tm-preview-item mb-3">
                        <small class="tm-text-muted d-block mb-2">
                            <i class="far fa-calendar-alt me-1"></i> Deadline
                        </small>
                        <span id="previewDeadline" class="tm-text-muted">Không có</span>
                    </div>

                    <div class="tm-preview-item mb-3">
                        <small class="tm-text-muted d-block mb-2">
                            <i class="fas fa-flag me-1"></i> Priority
                        </small>
                        <span id="previewPriority" class="tm-badge tm-badge-warning">🟡 Medium</span>
                    </div>

                    <div class="tm-divider"></div>

                    <div class="tm-preview-item">
                        <small class="tm-text-muted d-block mb-3">
                            <i class="fas fa-users me-1"></i> Số người được gán
                        </small>
                        <div class="text-center">
                            <div class="display-4 font-weight-bold tm-text-primary mb-2" id="previewUserCount">0</div>
                            <small class="tm-text-muted">nhân viên</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('createTaskForm');
            const btnSubmit = document.getElementById('btnSubmit');
            const selectAllCheckbox = document.getElementById('selectAll');
            const userCheckboxes = document.querySelectorAll('.user-checkbox');
            const searchInput = document.getElementById('searchUsers');
            const selectedCountSpan = document.getElementById('selectedCount');

            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `tm-toast tm-toast-${type}`;
                toast.innerHTML = `
                    <div class="tm-toast-content">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} tm-toast-icon"></i>
                        <span class="tm-toast-message">${message}</span>
                        <button class="tm-toast-close" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                document.body.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }

            function updateSelectedCount() {
                const count = document.querySelectorAll('.user-checkbox:checked').length;
                selectedCountSpan.textContent = count;
                document.getElementById('previewUserCount').textContent = count;

                const visibleCheckboxes = Array.from(userCheckboxes).filter(cb =>
                    cb.closest('.tm-user-item').style.display !== 'none'
                );
                const checkedVisible = visibleCheckboxes.filter(cb => cb.checked);
                selectAllCheckbox.checked = visibleCheckboxes.length > 0 &&
                                           visibleCheckboxes.length === checkedVisible.length;
            }

            selectAllCheckbox.addEventListener('change', function() {
                userCheckboxes.forEach(cb => {
                    if (cb.closest('.tm-user-item').style.display !== 'none') {
                        cb.checked = this.checked;
                    }
                });
                updateSelectedCount();
            });

            userCheckboxes.forEach(cb => {
                cb.addEventListener('change', updateSelectedCount);
            });

            searchInput.addEventListener('input', function() {
                const searchText = this.value.toLowerCase().trim();
                document.querySelectorAll('.tm-user-item').forEach(item => {
                    const name = item.dataset.name || '';
                    const dept = item.dataset.dept || '';
                    const matches = name.includes(searchText) || dept.includes(searchText);
                    item.style.display = matches || searchText === '' ? '' : 'none';
                });
                updateSelectedCount();
            });

            // Live Preview
            document.getElementById('taskName').addEventListener('input', function() {
                const preview = document.getElementById('previewTaskName');
                const icon = '<i class="fas fa-clipboard-list me-1"></i>';
                if (this.value.trim()) {
                    preview.innerHTML = `${icon} ${this.value}`;
                    preview.classList.remove('tm-text-muted');
                    preview.classList.add('tm-text-dark');
                } else {
                    preview.innerHTML = `${icon} Tên task...`;
                    preview.classList.add('tm-text-muted');
                    preview.classList.remove('tm-text-dark');
                }
            });

            document.getElementById('description').addEventListener('input', function() {
                const preview = document.getElementById('previewDescription');
                preview.textContent = this.value.trim() || 'Mô tả...';
                preview.classList.toggle('tm-text-muted', !this.value.trim());
                if (this.value.trim()) {
                    preview.classList.add('tm-text-dark');
                } else {
                    preview.classList.remove('tm-text-dark');
                }
            });

            document.getElementById('platform').addEventListener('change', function() {
                const preview = document.getElementById('previewPlatform');
                const value = this.value;
                if (value) {
                    const text = this.options[this.selectedIndex].text;
                    preview.textContent = text;
                    preview.className = 'tm-badge tm-badge-info';
                } else {
                    preview.textContent = 'N/A';
                    preview.className = 'tm-badge tm-badge-secondary';
                }
            });

            document.getElementById('deadline').addEventListener('change', function() {
                const preview = document.getElementById('previewDeadline');
                if (this.value) {
                    const date = new Date(this.value);
                    preview.textContent = date.toLocaleString('vi-VN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    preview.classList.remove('tm-text-muted');
                    preview.classList.add('tm-text-dark', 'font-weight-bold');
                } else {
                    preview.textContent = 'Không có';
                    preview.classList.add('tm-text-muted');
                    preview.classList.remove('tm-text-dark', 'font-weight-bold');
                }
            });

            document.getElementById('priority').addEventListener('change', function() {
                const preview = document.getElementById('previewPriority');
                const priority = this.value;
                const badgeClass = priority === 'High' ? 'tm-badge-danger' :
                                 priority === 'Medium' ? 'tm-badge-warning' : 'tm-badge-success';
                const icon = priority === 'High' ? '🔴' :
                           priority === 'Medium' ? '🟡' : '🟢';
                preview.className = `tm-badge ${badgeClass}`;
                preview.textContent = `${icon} ${priority}`;
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const taskName = document.getElementById('taskName').value.trim();
                const description = document.getElementById('description').value.trim();
                const platform = document.getElementById('platform').value;
                const deadlineInput = document.getElementById('deadline').value;
                const deadline = deadlineInput ? new Date(deadlineInput).toISOString() : null;
                const priority = document.getElementById('priority').value;

                const assignedUserIds = Array.from(document.querySelectorAll('.user-checkbox:checked'))
                    .map(cb => parseInt(cb.value));

                if (!taskName) {
                    showToast('Vui lòng nhập tên task!', 'danger');
                    document.getElementById('taskName').focus();
                    return;
                }

                btnSubmit.disabled = true;
                btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Đang tạo...';

                fetch('@Url.Action("CreateTaskPost", "Admin")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        taskName: taskName,
                        description: description,
                        platform: platform,
                        targetPerWeek: 0,
                        deadline: deadline,
                        priority: priority,
                        assignedUserIds: assignedUserIds
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                        setTimeout(() => {
                            window.location.href = '@Url.Action("TaskList", "Admin")';
                        }, 1500);
                    } else {
                        showToast(data.message || 'Có lỗi xảy ra!', 'danger');
                        btnSubmit.disabled = false;
                        btnSubmit.innerHTML = '<i class="fas fa-save me-2"></i> Tạo Task';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Có lỗi xảy ra khi tạo task!', 'danger');
                    btnSubmit.disabled = false;
                    btnSubmit.innerHTML = '<i class="fas fa-save me-2"></i> Tạo Task';
                });
            });
        });
    </script>
}