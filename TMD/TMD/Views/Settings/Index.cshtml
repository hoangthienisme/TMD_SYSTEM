@model List<TMD.Models.SystemSetting>
@{
    ViewData["Title"] = "Cấu Hình Hệ Thống";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .settings-container {
        max-width: 100%;
        margin: 0 auto;
    }

    .setting-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }

        .setting-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .setting-card.modified {
            border-left-color: #ffc107;
            background-color: #fffbf0;
        }

    .setting-input, .setting-select {
        transition: border-color 0.3s;
    }

        .setting-input.modified, .setting-select.modified {
            border-color: #ffc107 !important;
            border-width: 2px !important;
        }

    .category-badge {
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 4px;
    }

    .badge-salary {
        background-color: #28a745;
        color: white;
    }

    .badge-attendance {
        background-color: #17a2b8;
        color: white;
    }

    .badge-general {
        background-color: #6c757d;
        color: white;
    }

    .badge-notification {
        background-color: #ffc107;
        color: #000;
    }

    .badge-branding {
        background-color: #3498db;
        color: white;
    }

    .save-indicator {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1050;
        display: none;
    }

    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
    }

    .monaco-editor-container {
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #dee2e6;
        height: 600px;
        width: 100%;
    }

    .preview-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        border: 2px dashed #dee2e6;
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .preview-title {
        font-weight: bold;
        color: #2d2d2d;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .preview-content {
        min-height: 200px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        background: #fafafa;
    }

    .nav-pills .nav-link {
        color: #495057;
        font-weight: 600;
        transition: all 0.3s;
    }

        .nav-pills .nav-link.active {
            background-color: #E74C3C;
        }

        .nav-pills .nav-link:hover {
            background-color: rgba(231, 76, 60, 0.1);
        }

    .holiday-row:hover {
        background-color: #f8f9fa;
    }

    .badge-multiplier {
        font-size: 1rem;
        padding: 8px 12px;
    }

    .badge-national {
        background-color: #dc3545;
    }

    .badge-lunar {
        background-color: #ffc107;
        color: #000;
    }

    .badge-company {
        background-color: #17a2b8;
    }

    .image-upload-preview {
        max-width: 300px;
        margin-top: 10px;
        border-radius: 8px;
        border: 2px solid #dee2e6;
    }

    .image-upload-wrapper {
        position: relative;
        display: inline-block;
    }

    .image-upload-btn {
        margin-top: 10px;
    }

    .color-picker-wrapper {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .color-preview {
        width: 50px;
        height: 38px;
        border-radius: 6px;
        border: 2px solid #dee2e6;
    }

    /* Layout Editor toggle/collapsed */
    .editor-collapsed {
        display: none;
    }
</style>

<div class="settings-container container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1"><i class="fas fa-cog text-primary"></i> Cấu Hình Hệ Thống Nâng Cao</h2>
                            <p class="text-muted mb-0"><i class="fas fa-magic"></i> Tùy chỉnh Branding, Layout Editor, Lương, Chấm công — không cần deploy.</p>
                        </div>
                        <div>
                            <button class="btn btn-success btn-lg" id="btnSaveAll">
                                <i class="fas fa-save"></i> Lưu Tất Cả
                                <span class="badge bg-white text-success ms-2" id="modifiedCount">0</span>
                            </button>
                            <button class="btn btn-secondary btn-lg ms-2" onclick="location.reload()">
                                <i class="fas fa-redo"></i> Tải Lại
                            </button>
                            <div class="btn-group ms-2">
                                <button type="button" class="btn btn-info btn-lg dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i> Nâng Cao
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="/Settings/ExportSettings">
                                            <i class="fas fa-download text-primary"></i> Export Settings
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="$('#importFile').click(); return false;">
                                            <i class="fas fa-upload text-success"></i> Import Settings
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" onclick="resetToDefault(); return false;">
                                            <i class="fas fa-exclamation-triangle"></i> Reset về Mặc Định
                                        </a>
                                    </li>
                                </ul>
                            </div>
                            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importSettings(this)" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-2 col-6 mb-3">
            <div class="stats-card">
                <h6 class="opacity-75 mb-2">Tổng Cấu Hình</h6>
                <h3 class="mb-0">@Model.Count</h3>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h6 class="opacity-75 mb-2">Lương</h6>
                <h3 class="mb-0">@Model.Count(s => s.Category == "Salary")</h3>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <h6 class="opacity-75 mb-2">Chấm Công</h6>
                <h3 class="mb-0">@Model.Count(s => s.Category == "Attendance")</h3>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <h6 class="opacity-75 mb-2">Ngày Lễ</h6>
                <h3 class="mb-0" id="holidaysStatCount">0</h3>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                <h6 class="opacity-75 mb-2">Custom Code</h6>
                <h3 class="mb-0">@Model.Count(s => s.Category == "CustomCode")</h3>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <h6 class="opacity-75 mb-2">Đã Sửa</h6>
                <h3 class="mb-0" id="modifiedCountLarge">0</h3>
            </div>
        </div>
    </div>

    <!-- Save Indicator -->
    <div class="save-indicator alert alert-warning" id="saveIndicator">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="modifiedText">Bạn có thay đổi chưa lưu!</span>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-pills mb-4" role="tablist">
        <!-- Removed: Custom Code + Layout & Design -->
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#branding-tab">
                <i class="fas fa-paint-brush"></i> Branding & Logo
                <span class="badge bg-info ms-1">New</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#salary-tab">
                <i class="fas fa-money-bill-wave"></i> Lương
                <span class="badge bg-success ms-1">@Model.Count(s => s.Category == "Salary")</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#attendance-tab">
                <i class="fas fa-clock"></i> Chấm Công
                <span class="badge bg-info ms-1">@Model.Count(s => s.Category == "Attendance")</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#general-tab">
                <i class="fas fa-cogs"></i> Chung
                <span class="badge bg-secondary ms-1">@Model.Count(s => s.Category == "General")</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#notification-tab">
                <i class="fas fa-bell"></i> Thông Báo
                <span class="badge bg-warning text-dark ms-1">@Model.Count(s => s.Category == "Notification")</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#holidays-tab">
                <i class="fas fa-calendar-day"></i> Ngày Lễ/Nghỉ
                <span class="badge bg-primary ms-1" id="holidaysCount">0</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#layout-editor-tab">
                <i class="fas fa-code"></i> Layout Editor
                <span class="badge bg-danger ms-1">New</span>
            </a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- BRANDING & LOGO -->
        <div class="tab-pane fade show active" id="branding-tab">
            <div class="alert alert-info">
                <i class="fas fa-paint-brush"></i>
                <strong>Branding:</strong> Đổi logo, màu sắc, font chữ - Tạo thương hiệu riêng cho hệ thống!
            </div>

            <div class="row">
                <!-- Logo Upload -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-image"></i> Logo Upload</h5>
                        </div>
                        <div class="card-body">
                            @{
                                var logoUrl = Model.FirstOrDefault(s => s.SettingKey == "LOGO_URL");
                                var logoValue = logoUrl?.SettingValue ?? "/images/logo.png";
                            }
                            <label class="form-label fw-bold">Logo URL</label>
                            <input type="text" class="form-control setting-input"
                                   data-key="LOGO_URL"
                                   data-original="@logoValue"
                                   value="@logoValue"
                                   placeholder="https://example.com/logo.png" />

                            <div class="image-upload-wrapper mt-3">
                                <img src="@logoValue" id="logoPreview" class="image-upload-preview" onerror="this.src='/images/placeholder-logo.png'" />
                            </div>

                            <button class="btn btn-outline-primary image-upload-btn" onclick="$('#logoUploadInput').click()">
                                <i class="fas fa-upload"></i> Upload Logo Mới
                            </button>
                            <input type="file" id="logoUploadInput" accept="image/*" style="display:none" onchange="uploadLogo(this)" />
                        </div>
                    </div>
                </div>

                <!-- Colors -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header" style="background: #E74C3C; color: white;">
                            <h5 class="mb-0"><i class="fas fa-palette"></i> Màu Sắc Chủ Đạo</h5>
                        </div>
                        <div class="card-body">
                            @{
                                var primaryColor = Model.FirstOrDefault(s => s.SettingKey == "PRIMARY_COLOR");
                                var primaryValue = primaryColor?.SettingValue ?? "#E74C3C";
                                var secondaryColor = Model.FirstOrDefault(s => s.SettingKey == "SECONDARY_COLOR");
                                var secondaryValue = secondaryColor?.SettingValue ?? "#F39C12";
                            }
                            <label class="form-label fw-bold">Primary Color</label>
                            <div class="color-picker-wrapper">
                                <input type="color" class="form-control setting-input"
                                       data-key="PRIMARY_COLOR"
                                       data-original="@primaryValue"
                                       value="@primaryValue"
                                       style="width: 100px;" />
                                <input type="text" class="form-control" id="primaryColorHex" value="@primaryValue" readonly />
                                <div class="color-preview" id="primaryColorPreview" style="background: @primaryValue;"></div>
                            </div>

                            <label class="form-label fw-bold mt-3">Secondary Color</label>
                            <div class="color-picker-wrapper">
                                <input type="color" class="form-control setting-input"
                                       data-key="SECONDARY_COLOR"
                                       data-original="@secondaryValue"
                                       value="@secondaryValue"
                                       style="width: 100px;" />
                                <input type="text" class="form-control" id="secondaryColorHex" value="@secondaryValue" readonly />
                                <div class="color-preview" id="secondaryColorPreview" style="background: @secondaryValue;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typography -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0"><i class="fas fa-font"></i> Typography</h5>
                        </div>
                        <div class="card-body">
                            @{
                                var fontFamily = Model.FirstOrDefault(s => s.SettingKey == "FONT_FAMILY");
                                var fontValue = fontFamily?.SettingValue ?? "Segoe UI";
                                var fontSize = Model.FirstOrDefault(s => s.SettingKey == "FONT_SIZE_BASE");
                                var sizeValue = fontSize?.SettingValue ?? "16";
                            }
                            <label class="form-label fw-bold">Font Family</label>
                            <select class="form-select setting-select" data-key="FONT_FAMILY" data-original="@fontValue">
                                <option value="Segoe UI" selected="@(fontValue == "Segoe UI")">Segoe UI</option>
                                <option value="Arial" selected="@(fontValue == "Arial")">Arial</option>
                                <option value="Helvetica" selected="@(fontValue == "Helvetica")">Helvetica</option>
                                <option value="Roboto" selected="@(fontValue == "Roboto")">Roboto</option>
                                <option value="Open Sans" selected="@(fontValue == "Open Sans")">Open Sans</option>
                                <option value="Lato" selected="@(fontValue == "Lato")">Lato</option>
                            </select>

                            <label class="form-label fw-bold mt-3">Font Size Base (px)</label>
                            <input type="number" class="form-control setting-input"
                                   data-key="FONT_SIZE_BASE"
                                   data-original="@sizeValue"
                                   value="@sizeValue"
                                   min="12" max="24" />
                        </div>
                    </div>
                </div>

                <!-- Company Info -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-building"></i> Company Info</h5>
                        </div>
                        <div class="card-body">
                            @{
                                var displayName = Model.FirstOrDefault(s => s.SettingKey == "SYSTEM_DISPLAY_NAME");
                                var displayValue = displayName?.SettingValue ?? "TMD System";
                                var tagline = Model.FirstOrDefault(s => s.SettingKey == "SYSTEM_TAGLINE");
                                var taglineValue = tagline?.SettingValue ?? "Quản lý nhân sự thông minh";
                            }
                            <label class="form-label fw-bold">Tên Hiển Thị</label>
                            <input type="text" class="form-control setting-input"
                                   data-key="SYSTEM_DISPLAY_NAME"
                                   data-original="@displayValue"
                                   value="@displayValue"
                                   placeholder="Tên hệ thống" />

                            <label class="form-label fw-bold mt-3">Tagline</label>
                            <input type="text" class="form-control setting-input"
                                   data-key="SYSTEM_TAGLINE"
                                   data-original="@taglineValue"
                                   value="@taglineValue"
                                   placeholder="Slogan công ty" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SALARY -->
        <div class="tab-pane fade" id="salary-tab">
            <div class="row">
                @foreach (var setting in Model.Where(s => s.Category == "Salary"))
                {
                    <div class="col-md-6 mb-3">
                        <div class="card setting-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="card-title mb-1"><i class="fas fa-money-bill-wave text-success"></i> @setting.SettingKey</h5>
                                        <p class="text-muted small mb-0"><i class="fas fa-info-circle"></i> @setting.Description</p>
                                    </div>
                                    <span class="category-badge badge-salary">@setting.Category</span>
                                </div>

                                @if (setting.DataType == "Number" || setting.DataType == "Decimal")
                                {
                                    <input type="number" class="form-control setting-input"
                                           data-key="@setting.SettingKey"
                                           data-original="@setting.SettingValue"
                                           value="@setting.SettingValue"
                                           step="@(setting.DataType == "Decimal" ? "0.01" : "1")"
                                           placeholder="Nhập @setting.Description" />
                                }
                                else
                                {
                                    <input type="text" class="form-control setting-input"
                                           data-key="@setting.SettingKey"
                                           data-original="@setting.SettingValue"
                                           value="@setting.SettingValue"
                                           placeholder="Nhập giá trị..." />
                                }

                                @if (setting.UpdatedAt.HasValue)
                                {
                                    <small class="text-muted d-block mt-2"><i class="fas fa-clock"></i> Cập nhật: @setting.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- ATTENDANCE -->
        <div class="tab-pane fade" id="attendance-tab">
            <div class="row">
                @foreach (var setting in Model.Where(s => s.Category == "Attendance"))
                {
                    <div class="col-md-6 mb-3">
                        <div class="card setting-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="card-title mb-1"><i class="fas fa-clock text-info"></i> @setting.SettingKey</h5>
                                        <p class="text-muted small mb-0"><i class="fas fa-info-circle"></i> @setting.Description</p>
                                    </div>
                                    <span class="category-badge badge-attendance">@setting.Category</span>
                                </div>

                                @if (setting.DataType == "Boolean")
                                {
                                    <select class="form-select setting-select" data-key="@setting.SettingKey" data-original="@setting.SettingValue">
                                        <option value="true" selected="@(setting.SettingValue?.ToLower() == "true")">Có (True)</option>
                                        <option value="false" selected="@(setting.SettingValue?.ToLower() == "false")">Không (False)</option>
                                    </select>
                                }
                                else if (setting.DataType == "Number" || setting.DataType == "Decimal")
                                {
                                    <input type="number" class="form-control setting-input"
                                           data-key="@setting.SettingKey"
                                           data-original="@setting.SettingValue"
                                           value="@setting.SettingValue"
                                           step="@(setting.DataType == "Decimal" ? "0.01" : "1")" />
                                }
                                else if (setting.SettingKey.Contains("TIME"))
                                {
                                    <input type="time" class="form-control setting-input"
                                           data-key="@setting.SettingKey"
                                           data-original="@setting.SettingValue"
                                           value="@setting.SettingValue" />
                                }
                                else
                                {
                                    <input type="text" class="form-control setting-input"
                                           data-key="@setting.SettingKey"
                                           data-original="@setting.SettingValue"
                                           value="@setting.SettingValue" />
                                }

                                @if (setting.UpdatedAt.HasValue)
                                {
                                    <small class="text-muted d-block mt-2"><i class="fas fa-clock"></i> @setting.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- GENERAL -->
        <div class="tab-pane fade" id="general-tab">
            <div class="row">
                @foreach (var setting in Model.Where(s => s.Category == "General"))
                {
                    <div class="col-md-6 mb-3">
                        <div class="card setting-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="card-title mb-1"><i class="fas fa-cogs text-secondary"></i> @setting.SettingKey</h5>
                                        <p class="text-muted small mb-0"><i class="fas fa-info-circle"></i> @setting.Description</p>
                                    </div>
                                    <span class="category-badge badge-general">@setting.Category</span>
                                </div>

                                <input type="text" class="form-control setting-input"
                                       data-key="@setting.SettingKey"
                                       data-original="@setting.SettingValue"
                                       value="@setting.SettingValue"
                                       placeholder="Nhập @setting.Description" />

                                @if (setting.UpdatedAt.HasValue)
                                {
                                    <small class="text-muted d-block mt-2"><i class="fas fa-clock"></i> @setting.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- NOTIFICATION -->
        <div class="tab-pane fade" id="notification-tab">
            <div class="row">
                @foreach (var setting in Model.Where(s => s.Category == "Notification"))
                {
                    <div class="col-md-6 mb-3">
                        <div class="card setting-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="card-title mb-1"><i class="fas fa-bell text-warning"></i> @setting.SettingKey</h5>
                                        <p class="text-muted small mb-0"><i class="fas fa-info-circle"></i> @setting.Description</p>
                                    </div>
                                    <span class="category-badge badge-notification">@setting.Category</span>
                                </div>

                                @if (setting.DataType == "Boolean")
                                {
                                    <select class="form-select setting-select" data-key="@setting.SettingKey" data-original="@setting.SettingValue">
                                        <option value="true" selected="@(setting.SettingValue?.ToLower() == "true")">Bật (True)</option>
                                        <option value="false" selected="@(setting.SettingValue?.ToLower() == "false")">Tắt (False)</option>
                                    </select>
                                }
                                else if (setting.DataType == "Number")
                                {
                                    <input type="number" class="form-control setting-input"
                                           data-key="@setting.SettingKey"
                                           data-original="@setting.SettingValue"
                                           value="@setting.SettingValue"
                                           step="1" />
                                }
                                else
                                {
                                    <input type="text" class="form-control setting-input"
                                           data-key="@setting.SettingKey"
                                           data-original="@setting.SettingValue"
                                           value="@setting.SettingValue" />
                                }

                                @if (setting.UpdatedAt.HasValue)
                                {
                                    <small class="text-muted d-block mt-2"><i class="fas fa-clock"></i> @setting.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- HOLIDAYS -->
        <div class="tab-pane fade" id="holidays-tab">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Lưu ý:</strong> Danh sách ngày lễ, tết để tính lương với hệ số đặc biệt.
            </div>

            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Thêm Ngày Lễ Mới</h5>
                </div>
                <div class="card-body">
                    <form id="formAddHoliday">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Ngày <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="holidayDate" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Tên Ngày Lễ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="holidayName" placeholder="VD: Tết Nguyên Đán" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Hệ Số <span class="text-danger">*</span></label>
                                <select class="form-select" id="salaryMultiplier" required>
                                    <option value="2">x2</option>
                                    <option value="3">x3</option>
                                    <option value="1.5">x1.5</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Loại</label>
                                <select class="form-select" id="holidayType">
                                    <option value="National">Quốc Gia</option>
                                    <option value="Lunar">Tết</option>
                                    <option value="Company">Công Ty</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label fw-bold">&nbsp;</label>
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Danh Sách Ngày Lễ</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="holidaysTable">
                            <thead>
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="15%">Ngày</th>
                                    <th width="35%">Tên</th>
                                    <th width="15%">Hệ Số</th>
                                    <th width="15%">Loại</th>
                                    <th width="15%">Thao Tác</th>
                                </tr>
                            </thead>
                            <tbody id="holidaysTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- LAYOUT EDITOR (collapsed by default, with Copy + Import .txt + Move to Trash) -->
        <div class="tab-pane fade" id="layout-editor-tab">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>⚠️ CHÚ Ý:</strong> Bạn đang chỉnh sửa trực tiếp file Layout (.cshtml).
                Hãy cẩn thận và luôn backup trước khi lưu.
            </div>

            <!-- Layout Selector -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-file-code"></i> Chọn Layout để chỉnh sửa</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-lg btn-outline-primary active" id="btnSelectAdmin" onclick="loadLayout('admin')">
                            <i class="fas fa-user-shield"></i> Admin Layout
                            <br><small>Views/Shared/_Layout.cshtml</small>
                        </button>
                        <button type="button" class="btn btn-lg btn-outline-success" id="btnSelectStaff" onclick="loadLayout('staff')">
                            <i class="fas fa-users"></i> Staff Layout
                            <br><small>Views/Shared/_LayoutStaff.cshtml</small>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Layout Editor (default collapsed) -->
            <div class="card mb-4">
                <div class="card-header" style="background: #2d2d2d; color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="fas fa-edit"></i> <span id="currentLayoutFileName">_Layout.cshtml</span></h5>
                            <small id="currentLayoutInfo">Last modified: --</small>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" onclick="saveLayoutFile()">
                                <i class="fas fa-save"></i> Lưu File
                            </button>
                            <button class="btn btn-sm btn-info" onclick="formatLayoutCode()">
                                <i class="fas fa-magic"></i> Format
                            </button>
                            <button class="btn btn-sm btn-dark" onclick="copyLayoutSource()">
                                <i class="fas fa-copy"></i> Copy source
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="document.getElementById('importTxtInput').click()">
                                <i class="fas fa-file-import"></i> Import code (.txt)
                            </button>
                            <input type="file" id="importTxtInput" accept=".txt" style="display:none" onchange="importTxtAppend(event)">
                            <button class="btn btn-sm btn-warning" onclick="loadLayout(currentLayoutType)">
                                <i class="fas fa-sync"></i> Reload
                            </button>
                            <button class="btn btn-sm btn-primary" id="toggleEditorBtn" onclick="toggleMainLayoutEditor(true)">
                                <i class="fas fa-pencil-alt"></i> Edit
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0 editor-collapsed" id="mainLayoutEditorSection">
                    <div id="layoutEditor" style="height: 600px; border: 1px solid #dee2e6;"></div>
                </div>
            </div>

            <!-- Backup Management -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Backup & Restore</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary mb-3" onclick="loadBackupList()">
                        <i class="fas fa-sync"></i> Refresh Backup List
                    </button>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="30%">File Name</th>
                                    <th width="15%">Layout</th>
                                    <th width="15%">Size</th>
                                    <th width="20%">Created</th>
                                    <th width="15%">Action</th>
                                </tr>
                            </thead>
                            <tbody id="backupListBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                        Chưa có backup. Click "Lưu File" để tự động tạo backup.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="mt-2">
                            <small class="text-muted">Xóa backup sẽ chuyển vào thùng rác (Trash). Có thể khôi phục khi cần.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- end layout-editor-tab -->
    </div> <!-- end tab-content -->
</div> <!-- end settings-container -->
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let modifiedSettings = new Set();
        let originalValues = {};
        let monacoEditors = {}; // reserved for any additional editors if needed
        let layoutEditor;
        let currentLayoutType = 'admin';
        let layoutEditorInitialized = false;

        $(document).ready(function() {
            initializeRegularInputs();
            initializeColorPickers();
            loadHolidays();
        });

        function initializeRegularInputs() {
            $('[data-key]:not(.monaco-input)').each(function() {
                const key = $(this).data('key');
                originalValues[key] = $(this).val();
            });

            $('[data-key]:not(.monaco-input)').on('change input', function() {
                const key = $(this).data('key');
                const newValue = $(this).val();

                if (newValue !== originalValues[key]) {
                    modifiedSettings.add(key);
                    $(this).addClass('modified');
                    $(this).closest('.setting-card').addClass('modified');
                } else {
                    modifiedSettings.delete(key);
                    $(this).removeClass('modified');
                    $(this).closest('.setting-card').removeClass('modified');
                }
                updateModifiedCount();
            });
        }

        function initializeColorPickers() {
            $('input[type="color"]').on('input', function() {
                const color = $(this).val();
                const id = $(this).data('key');

                if (id === 'PRIMARY_COLOR') {
                    $('#primaryColorHex').val(color);
                    $('#primaryColorPreview').css('background', color);
                } else if (id === 'SECONDARY_COLOR') {
                    $('#secondaryColorHex').val(color);
                    $('#secondaryColorPreview').css('background', color);
                }
            });
        }

        // -------- Layout Editor (lazy Monaco init) --------
        function ensureMonacoForLayout() {
            return new Promise((resolve, reject) => {
                if (layoutEditorInitialized) { resolve(); return; }
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js';
                script.onload = function() {
                    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
                    require(['vs/editor/editor.main'], function () {
                        layoutEditor = monaco.editor.create(document.getElementById('layoutEditor'), {
                            value: '<!-- Loading... -->',
                            language: 'html',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: { enabled: true },
                            fontSize: 14,
                            wordWrap: 'on',
                            scrollBeyondLastLine: false,
                            lineNumbers: 'on',
                            renderWhitespace: 'selection',
                            folding: true,
                            formatOnPaste: true,
                            formatOnType: true
                        });
                        layoutEditorInitialized = true;
                        loadLayout(currentLayoutType);
                        resolve();
                    });
                };
                script.onerror = function() { reject('Không thể tải Monaco Editor.'); };
                document.head.appendChild(script);
            });
        }

        function toggleMainLayoutEditor(openRequested = false) {
            const section = document.getElementById('mainLayoutEditorSection');
            const btn = document.getElementById('toggleEditorBtn');
            const isCollapsed = section.classList.contains('editor-collapsed');

            if (isCollapsed || openRequested) {
                section.classList.remove('editor-collapsed');
                btn.innerHTML = '<i class="fas fa-times"></i> Close editor';
                ensureMonacoForLayout()
                    .then(() => setTimeout(() => layoutEditor && layoutEditor.layout(), 100))
                    .catch(err => Swal.fire('Lỗi', String(err), 'error'));
            } else {
                section.classList.add('editor-collapsed');
                btn.innerHTML = '<i class="fas fa-pencil-alt"></i> Edit';
            }
        }

        function loadLayout(layoutType) {
            currentLayoutType = layoutType;
            $('#btnSelectAdmin').toggleClass('active', layoutType === 'admin');
            $('#btnSelectStaff').toggleClass('active', layoutType === 'staff');

            Swal.fire({ title: 'Đang tải...', html: 'Vui lòng đợi', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            fetch(`/Settings/GetLayoutContent?layoutType=${layoutType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (layoutEditor) {
                            layoutEditor.setValue(data.content);
                            layoutEditor.layout();
                        }
                        $('#currentLayoutFileName').text(data.fileName);
                        $('#currentLayoutInfo').text(`Last modified: ${data.lastModified}`);
                        Swal.close();
                        Swal.fire({ icon: 'success', title: 'Đã tải', text: data.fileName, timer: 900, showConfirmButton: false });
                    } else {
                        Swal.fire('Lỗi', data.message, 'error');
                    }
                })
                .catch(() => Swal.fire('Lỗi', 'Không thể tải layout file!', 'error'));
        }

        function saveLayoutFile() {
            if (!layoutEditor) {
                Swal.fire('Thông báo', 'Nhấn Edit để mở editor trước khi lưu.', 'info');
                return;
            }
            const content = layoutEditor.getValue();

            Swal.fire({
                title: 'Xác nhận lưu?',
                html: `<strong>⚠️ CHÚ Ý:</strong> Ghi đè file layout! Backup tự động sẽ được tạo.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-save"></i> Lưu',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#28a745'
            }).then((result) => {
                if (!result.isConfirmed) return;

                Swal.fire({ title: 'Đang lưu...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                fetch('/Settings/SaveLayoutFile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ layoutType: currentLayoutType, content })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({ icon: 'success', title: 'Đã lưu!', text: data.message, confirmButtonText: 'OK' })
                            .then(() => loadBackupList());
                    } else {
                        Swal.fire('Lỗi', data.message, 'error');
                    }
                })
                .catch(() => Swal.fire('Lỗi', 'Không thể lưu file!', 'error'));
            });
        }

        function formatLayoutCode() {
            if (!layoutEditor) {
                Swal.fire('Thông báo', 'Nhấn Edit để mở editor trước khi format.', 'info');
                return;
            }
            layoutEditor.getAction('editor.action.formatDocument').run();
            Swal.fire({ icon: 'success', title: 'Formatted!', timer: 800, showConfirmButton: false });
        }

        function copyLayoutSource() {
            if (!layoutEditor) {
                Swal.fire('Thông báo', 'Nhấn Edit để mở editor trước khi copy.', 'info');
                return;
            }
            const code = layoutEditor.getValue();
            navigator.clipboard.writeText(code)
                .then(() => Swal.fire({ icon: 'success', title: 'Đã copy', timer: 900, showConfirmButton: false }))
                .catch(() => Swal.fire('Lỗi', 'Không thể copy vào clipboard.', 'error'));
        }

        function importTxtAppend(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!layoutEditor) {
                Swal.fire('Thông báo', 'Nhấn Edit để mở editor trước khi import.', 'info');
                e.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(evt) {
                const content = evt.target.result || '';
                const current = layoutEditor.getValue();
                const merged = current + '\n\n' + content;
                layoutEditor.setValue(merged);
                layoutEditor.layout();
                Swal.fire({ icon: 'success', title: 'Đã chèn code', timer: 900, showConfirmButton: false });
                e.target.value = '';
            };
            reader.onerror = function() {
                Swal.fire('Lỗi', 'Không thể đọc file .txt', 'error');
                e.target.value = '';
            };
            reader.readAsText(file, 'utf-8');
        }

        function loadBackupList() {
            fetch('/Settings/GetBackupFiles')
                .then(r => r.json())
                .then(data => {
                    if (!data.success) return;
                    const tbody = $('#backupListBody');
                    tbody.empty();

                    if (!data.backups || data.backups.length === 0) {
                        tbody.append(`
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                    Chưa có backup
                                </td>
                            </tr>
                        `);
                        return;
                    }

                    data.backups.forEach((backup, index) => {
                        const sizeKB = (backup.size / 1024).toFixed(2);
                        const layoutBadge = backup.layoutType === 'admin'
                            ? '<span class="badge bg-primary">Admin</span>'
                            : '<span class="badge bg-success">Staff</span>';

                        tbody.append(`
                            <tr>
                                <td>${index + 1}</td>
                                <td><small>${backup.fileName}</small></td>
                                <td>${layoutBadge}</td>
                                <td>${sizeKB} KB</td>
                                <td>${backup.created}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="restoreBackup('${backup.fileName}')">
                                        <i class="fas fa-undo"></i> Restore
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="moveBackupToTrash('${backup.fileName}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `);
                    });
                })
                .catch(err => console.error('Error:', err));
        }

        function restoreBackup(backupFileName) {
            Swal.fire({
                title: 'Restore backup?',
                html: `Restore từ:<br><strong>${backupFileName}</strong>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Restore',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (!result.isConfirmed) return;
                fetch('/Settings/RestoreFromBackup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backupFileName })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Thành công!', data.message, 'success')
                            .then(() => { if (layoutEditorInitialized && layoutEditor) loadLayout(currentLayoutType); });
                    } else {
                        Swal.fire('Lỗi', data.message, 'error');
                    }
                });
            });
        }

        // Move backup to Trash (requires corresponding controller endpoint: MoveBackupToTrash)
        function moveBackupToTrash(backupFileName) {
            Swal.fire({
                title: 'Chuyển vào thùng rác?',
                text: 'Có thể khôi phục từ Trash sau này.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Chuyển',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (!result.isConfirmed) return;
                fetch('/Settings/MoveBackupToTrash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backupFileName })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Đã chuyển!', '', 'success');
                        loadBackupList();
                    } else {
                        Swal.fire('Lỗi', data.message, 'error');
                    }
                })
                .catch(() => Swal.fire('Lỗi', 'Không thể chuyển vào thùng rác!', 'error'));
            });
        }

        // Keep Monaco sized properly
        $(window).on('resize', function() {
            if (layoutEditorInitialized && layoutEditor) layoutEditor.layout();
            Object.values(monacoEditors).forEach(editor => editor.layout && editor.layout());
        });
        $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function () {
            setTimeout(function() {
                if (layoutEditorInitialized && layoutEditor) layoutEditor.layout();
                Object.values(monacoEditors).forEach(editor => editor.layout && editor.layout());
            }, 100);
        });

        // -------- Holidays --------
        let holidays = [];
        function loadHolidays() {
            const stored = localStorage.getItem('system_holidays');
            holidays = stored ? JSON.parse(stored) : [];
            renderHolidaysTable();
            updateHolidaysCount();
        }
        function saveHolidays() {
            localStorage.setItem('system_holidays', JSON.stringify(holidays));
            updateHolidaysCount();
        }
        function renderHolidaysTable() {
            const tbody = $('#holidaysTableBody');
            tbody.empty();

            if (holidays.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-2 d-block"></i>
                            Chưa có ngày lễ nào
                        </td>
                    </tr>
                `);
                return;
            }

            holidays.forEach((holiday, index) => {
                const dateObj = new Date(holiday.date);
                const formattedDate = dateObj.toLocaleDateString('vi-VN', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });

                tbody.append(`
                    <tr class="holiday-row">
                        <td class="text-center">${index + 1}</td>
                        <td><strong>${formattedDate}</strong></td>
                        <td>${holiday.name}</td>
                        <td><span class="badge badge-multiplier bg-success">x${holiday.multiplier}</span></td>
                        <td><span class="badge badge-${holiday.type.toLowerCase()}">${holiday.type}</span></td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteHoliday(${holiday.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
        }
        function deleteHoliday(id) {
            Swal.fire({
                title: 'Xác nhận xóa?', icon: 'warning',
                showCancelButton: true, confirmButtonText: 'Xóa', cancelButtonText: 'Hủy'
            }).then((result) => {
                if (!result.isConfirmed) return;
                holidays = holidays.filter(h => h.id !== id);
                saveHolidays();
                renderHolidaysTable();
                Swal.fire('Đã xóa!', '', 'success');
            });
        }
        function updateHolidaysCount() {
            $('#holidaysCount').text(holidays.length);
            $('#holidaysStatCount').text(holidays.length);
        }
        $('#formAddHoliday').on('submit', function(e) {
            e.preventDefault();
            const holiday = {
                id: Date.now(),
                date: $('#holidayDate').val(),
                name: $('#holidayName').val(),
                multiplier: parseFloat($('#salaryMultiplier').val()),
                type: $('#holidayType').val()
            };
            if (holidays.some(h => h.date === holiday.date)) {
                Swal.fire('Cảnh báo', 'Ngày này đã tồn tại!', 'warning');
                return;
            }
            holidays.push(holiday);
            holidays.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveHolidays();
            renderHolidaysTable();
            Swal.fire({ icon: 'success', title: 'Thành công!', text: 'Đã thêm ngày lễ', timer: 1200, showConfirmButton: false });
            this.reset();
        });

        // -------- Import/Export/Reset --------
        function uploadLogo(input) {
            const file = input.files[0];
            if (!file) return;
            Swal.fire({ title: 'Đang upload...', html: 'Vui lòng đợi', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const formData = new FormData(); formData.append('file', file);
            fetch('/Settings/UploadLogo', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    $('#logoPreview').attr('src', data.logoUrl);
                    $('[data-key="LOGO_URL"]').val(data.logoUrl);
                    Swal.fire({ icon: 'success', title: 'Upload thành công!', text: 'Logo đã được cập nhật', timer: 1500 });
                } else {
                    Swal.fire('Lỗi', data.message, 'error');
                }
            })
            .catch(() => Swal.fire('Lỗi', 'Không thể upload logo!', 'error'));
            input.value = '';
        }

        function importSettings(input) {
            const file = input.files[0];
            if (!file) return;
            Swal.fire({ title: 'Đang import...', html: 'Vui lòng đợi', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const formData = new FormData(); formData.append('file', file);
            fetch('/Settings/ImportSettings', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({ icon: 'success', title: 'Thành công!', text: data.message, confirmButtonText: 'Reload' })
                        .then(() => location.reload());
                } else {
                    Swal.fire('Lỗi', data.message, 'error');
                }
            })
            .catch(() => Swal.fire('Lỗi', 'Không thể import file!', 'error'));
            input.value = '';
        }

        function resetToDefault() {
            Swal.fire({
                title: 'Xác nhận Reset?',
                html: '<strong>CẢNH BÁO:</strong> Tất cả cấu hình sẽ về mặc định!<br>Bạn có chắc chắn?',
                icon: 'warning', showCancelButton: true,
                confirmButtonText: 'Reset', cancelButtonText: 'Hủy', confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (!result.isConfirmed) return;
                fetch('/Settings/ResetToDefault', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({ icon: 'success', title: 'Đã reset!', confirmButtonText: 'Reload' })
                            .then(() => location.reload());
                    } else {
                        Swal.fire('Lỗi', data.message, 'error');
                    }
                })
                .catch(() => Swal.fire('Lỗi', 'Không thể reset!', 'error'));
            });
        }

        // Save all settings (batch)
        function updateModifiedCount() {
            const count = modifiedSettings.size;
            $('#modifiedCount').text(count);
            $('#modifiedCountLarge').text(count);
            if (count > 0) {
                $('#saveIndicator').fadeIn();
                $('#btnSaveAll').removeClass('btn-success').addClass('btn-warning');
            } else {
                $('#saveIndicator').fadeOut();
                $('#btnSaveAll').removeClass('btn-warning').addClass('btn-success');
            }
        }

        $('#btnSaveAll').click(function() {
            if (modifiedSettings.size === 0) {
                Swal.fire({ icon: 'info', title: 'Không có thay đổi', text: 'Bạn chưa thay đổi gì cả!', timer: 1500 });
                return;
            }
            const settings = [];
            Object.keys(monacoEditors).forEach(key => {
                const editorValue = monacoEditors[key].getValue();
                $(`#input-${key}`).val(editorValue);
            });
            modifiedSettings.forEach(key => {
                const element = $(`[data-key="${key}"]`);
                const value = element.val();
                settings.push({ SettingKey: key, SettingValue: value });
            });

            Swal.fire({
                title: 'Xác nhận lưu',
                html: `Lưu <strong>${settings.length}</strong> cấu hình?`,
                icon: 'question', showCancelButton: true,
                confirmButtonText: '<i class="fas fa-save"></i> Lưu', cancelButtonText: 'Hủy',
                confirmButtonColor: '#28a745', cancelButtonColor: '#6c757d'
            }).then((result) => { if (result.isConfirmed) saveSettings(settings); });
        });

        function saveSettings(settings) {
            Swal.fire({ title: 'Đang lưu...', html: 'Vui lòng đợi', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            fetch('/Settings/BatchUpdateSettings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(settings)
            })
            .then(r => { if (!r.ok) throw new Error('Network error'); return r.json(); })
            .then(data => {
                if (data.success) {
                    Swal.fire({ icon: 'success', title: 'Thành công!', text: data.message || 'Đã lưu cấu hình!', timer: 1500, showConfirmButton: false })
                        .then(() => location.reload());
                } else {
                    Swal.fire({ icon: 'error', title: 'Lỗi', text: data.message || 'Có lỗi xảy ra khi lưu!' });
                }
            })
            .catch(() => Swal.fire({ icon: 'error', title: 'Lỗi kết nối', text: 'Không thể kết nối đến server!' }));
        }
    </script>
}
