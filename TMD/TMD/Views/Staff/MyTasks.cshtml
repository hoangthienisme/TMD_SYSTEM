@model List<TMD.Models.UserTask>
@{
    ViewData["Title"] = "Công việc của tôi";
    Layout = "~/Views/Shared/_LayoutStaff.cshtml";
}

<link href="~/css/tasklist-ad.css" rel="stylesheet" />

<div class="tm-container">
    <!-- PAGE HEADER -->
    <div class="tm-page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="tm-page-title">
                    <i class="fas fa-clipboard-list me-2"></i> Công việc của tôi
                </h2>
                <p class="tm-page-subtitle">Quản lý và cập nhật trạng thái công việc được giao</p>
            </div>
            <div>
                <span class="tm-badge tm-badge-info" style="font-size: 1rem; padding: 0.75rem 1.25rem;">
                    <i class="fas fa-tasks me-2"></i> Tổng: @Model.Count công việc
                </span>
            </div>
        </div>
    </div>

    <!-- STATISTICS -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="tm-stats-card tm-stats-secondary">
                <div class="tm-stats-icon">
                    <i class="fas fa-inbox"></i>
                </div>
                <div class="tm-stats-content">
                    <div class="tm-stats-label">Chưa bắt đầu</div>
                    <div class="tm-stats-value">@Model.Count(t => t.Status == "TODO")</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="tm-stats-card tm-stats-warning">
                <div class="tm-stats-icon">
                    <i class="fas fa-spinner"></i>
                </div>
                <div class="tm-stats-content">
                    <div class="tm-stats-label">Đang làm</div>
                    <div class="tm-stats-value">@Model.Count(t => t.Status == "InProgress")</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="tm-stats-card tm-stats-success">
                <div class="tm-stats-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="tm-stats-content">
                    <div class="tm-stats-label">Hoàn thành</div>
                    <div class="tm-stats-value">@Model.Count(t => t.Status == "Completed")</div>
                </div>
            </div>
        </div>
    </div>

    <!-- FILTERS -->
    <div class="tm-card mb-4">
        <div class="tm-card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="tm-form-label">
                        <i class="fas fa-search me-1"></i> Tìm kiếm
                    </label>
                    <input type="text" id="searchInput" class="tm-form-control" placeholder="Tên công việc...">
                </div>
                <div class="col-md-3">
                    <label class="tm-form-label">
                        <i class="fas fa-traffic-light me-1"></i> Trạng thái
                    </label>
                    <select id="statusFilter" class="tm-form-control">
                        <option value="">Tất cả</option>
                        <option value="TODO">Chưa bắt đầu</option>
                        <option value="InProgress">Đang làm</option>
                        <option value="Completed">Hoàn thành</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="tm-form-label">
                        <i class="fas fa-flag me-1"></i> Độ ưu tiên
                    </label>
                    <select id="priorityFilter" class="tm-form-control">
                        <option value="">Tất cả</option>
                        <option value="High">Cao</option>
                        <option value="Medium">Trung bình</option>
                        <option value="Low">Thấp</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (Model == null || Model.Count == 0)
    {
        <div class="tm-card">
            <div class="tm-card-body">
                <div class="tm-empty-state">
                    <i class="fas fa-inbox fa-4x"></i>
                    <p class="mt-3 mb-2"><strong>Chưa có công việc nào được giao</strong></p>
                    <p class="tm-text-muted">Hiện tại bạn chưa được phân công công việc nào.</p>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- TASK LIST -->
        <div class="tm-card">
            <div class="tm-card-body p-0">
                <div class="task-list" id="taskList">
                    @foreach (var userTask in Model)
                    {
                        var task = userTask.Task;

                        // ✅ XÁC ĐỊNH TRẠNG THÁI
                        string statusText = userTask.Status switch
                        {
                            "TODO" => "Chưa bắt đầu",
                            "InProgress" => "Đang làm",
                            "Completed" => "Hoàn thành",
                            _ => "Chưa bắt đầu"
                        };

                        string statusClass = userTask.Status switch
                        {
                            "TODO" => "secondary",
                            "InProgress" => "warning",
                            "Completed" => "success",
                            _ => "secondary"
                        };

                        string statusIcon = userTask.Status switch
                        {
                            "TODO" => "inbox",
                            "InProgress" => "spinner fa-spin",
                            "Completed" => "check-circle",
                            _ => "inbox"
                        };

                        // ✅ KIỂM TRA QUÁ HẠN
                        bool isOverdue = false;
                        bool isCompletedLate = false;

                        if (task.Deadline.HasValue)
                        {
                            if (userTask.Status == "Completed")
                            {
                                if (userTask.UpdatedAt.HasValue && userTask.UpdatedAt.Value > task.Deadline.Value)
                                {
                                    isCompletedLate = true;
                                    statusText = "Hoàn thành muộn";
                                    statusClass = "warning";
                                }
                            }
                            else
                            {
                                if (DateTime.Now > task.Deadline.Value)
                                {
                                    isOverdue = true;
                                }
                            }
                        }

                        <div class="task-list-item @(isOverdue ? "task-overdue" : "")"
                             data-task-id="@task.TaskId"
                             data-status="@userTask.Status"
                             data-priority="@(task.Priority ?? "Medium")"
                             data-platform="@(task.Platform ?? "")"
                             data-name="@task.TaskName.ToLower()">

                            <div class="task-list-header">
                                <div class="task-list-title-section">
                                    <h5 class="task-list-title">
                                        <i class="fas fa-tasks me-2"></i>
                                        @task.TaskName
                                    </h5>
                                    @if (!string.IsNullOrEmpty(task.Description))
                                    {
                                        <p class="task-list-description">@task.Description</p>
                                    }
                                </div>

                                <div class="task-list-badges">
                                    <span class="tm-badge tm-badge-@statusClass" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                                        <i class="fas fa-@statusIcon me-1"></i> @statusText
                                    </span>

                                    <span class="tm-badge tm-badge-@(task.Priority == "High" ? "danger" : task.Priority == "Low" ? "success" : "warning")">
                                        <i class="fas fa-flag me-1"></i> @(task.Priority ?? "Medium")
                                    </span>

                                    @if (!string.IsNullOrEmpty(task.Platform))
                                    {
                                        <span class="tm-badge tm-badge-info">
                                            <i class="fas fa-laptop me-1"></i> @task.Platform
                                        </span>
                                    }

                                    @if (isOverdue && userTask.Status != "Completed")
                                    {
                                        <span class="tm-badge tm-badge-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i> Đang quá hạn
                                        </span>
                                    }
                                    else if (isCompletedLate)
                                    {
                                        <span class="tm-badge tm-badge-warning">
                                            <i class="fas fa-exclamation-circle me-1"></i> Hoàn thành muộn
                                        </span>
                                    }
                                </div>
                            </div>

                            <div class="task-list-body">
                                <div class="task-list-info-grid">
                                    @if (task.Deadline.HasValue)
                                    {
                                        <div class="task-list-info-item">
                                            <i class="fas fa-calendar-alt @(isOverdue || isCompletedLate ? "text-danger" : "text-info")"></i>
                                            <span>
                                                <strong>Deadline:</strong>
                                                <span class="@(isOverdue || isCompletedLate ? "text-danger" : "")">
                                                    @task.Deadline.Value.ToString("dd/MM/yyyy HH:mm")
                                                </span>
                                            </span>
                                        </div>
                                    }

                                    @if (userTask.UpdatedAt.HasValue)
                                    {
                                        <div class="task-list-info-item">
                                            <i class="fas fa-clock text-secondary"></i>
                                            <span><strong>Cập nhật:</strong> @userTask.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                        </div>
                                    }
                                </div>

                                @if (!string.IsNullOrEmpty(userTask.ReportLink))
                                {
                                    <div class="task-report-link mt-3">
                                        <a href="@userTask.ReportLink" target="_blank" onclick="event.stopPropagation();">
                                            <i class="fas fa-link me-1"></i> Xem báo cáo
                                        </a>
                                    </div>
                                }
                            </div>

                            <div class="task-list-footer">
                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewTaskDetail(@userTask.UserTaskId)">
                                    <i class="fas fa-eye me-1"></i> Chi tiết
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); updateStatusModal(@userTask.UserTaskId, '@task.TaskName', '@userTask.Status', '@(userTask.ReportLink ?? "")')">
                                    <i class="fas fa-edit me-1"></i> Cập nhật
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

<!-- Modal: Update Status -->
<div class="modal fade tm-modal" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="tm-modal-header">
                <h5 class="tm-modal-title">
                    <i class="fas fa-edit me-2"></i> Cập nhật trạng thái
                </h5>
                <button type="button" class="tm-btn-close" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="tm-modal-body">
                <input type="hidden" id="updateUserTaskId">

                <div class="mb-3">
                    <label class="tm-form-label">Công việc:</label>
                    <p id="updateTaskName" class="tm-text-muted"></p>
                </div>

                <div class="mb-3">
                    <label class="tm-form-label">
                        <i class="fas fa-traffic-light me-1"></i> Trạng thái:
                    </label>
                    <div class="status-buttons">
                        <button type="button" class="status-btn" data-status="TODO" onclick="selectStatus('TODO')">
                            <i class="fas fa-inbox"></i>
                            <span>Chưa bắt đầu</span>
                        </button>
                        <button type="button" class="status-btn" data-status="InProgress" onclick="selectStatus('InProgress')">
                            <i class="fas fa-spinner"></i>
                            <span>Đang làm</span>
                        </button>
                        <button type="button" class="status-btn" data-status="Completed" onclick="selectStatus('Completed')">
                            <i class="fas fa-check-circle"></i>
                            <span>Hoàn thành</span>
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="updateReportLink" class="tm-form-label">
                        <i class="fas fa-link me-1"></i> Link báo cáo (tùy chọn):
                    </label>
                    <input type="url" class="tm-form-control" id="updateReportLink"
                           placeholder="https://drive.google.com/...">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Hủy
                </button>
                <button type="button" class="btn btn-primary" onclick="submitUpdateStatus()">
                    <i class="fas fa-save"></i> Lưu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Task Detail -->
<div class="modal fade tm-modal" id="taskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="tm-modal-header">
                <h5 class="tm-modal-title" id="detailTaskName">
                    <i class="fas fa-info-circle me-2"></i> Chi tiết công việc
                </h5>
                <button type="button" class="tm-btn-close" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="tm-modal-body" id="taskDetailContent">
                <div class="tm-loading">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2 tm-text-muted">Đang tải...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .task-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1.5rem;
    }

    .task-list-item {
        background: var(--tm-white);
        border: 1px solid var(--tm-gray-200);
        border-radius: var(--tm-border-radius);
        padding: 1.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .task-list-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--tm-primary);
        }

        .task-list-item.task-overdue {
            border-left: 4px solid var(--tm-danger);
        }

    .task-list-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--tm-gray-200);
    }

    .task-list-title-section {
        flex: 1;
    }

    .task-list-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--tm-dark);
        margin-bottom: 0.5rem;
    }

    .task-list-description {
        font-size: 0.9rem;
        color: var(--tm-gray-600);
        margin: 0;
    }

    .task-list-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .task-list-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .task-list-info-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9rem;
    }

        .task-list-info-item i {
            font-size: 1.1rem;
            width: 24px;
        }

    .task-list-footer {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        padding-top: 1rem;
        border-top: 1px solid var(--tm-gray-200);
    }

    .status-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
    }

    .status-btn {
        padding: 1rem;
        border: 2px solid var(--tm-gray-300);
        background: white;
        border-radius: var(--tm-border-radius-sm);
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

        .status-btn i {
            font-size: 1.5rem;
            color: var(--tm-gray-600);
        }

        .status-btn:hover {
            border-color: var(--tm-primary);
            background: rgba(231, 76, 60, 0.05);
        }

        .status-btn.active {
            border-color: var(--tm-primary);
            background: var(--tm-primary);
            color: white;
        }

            .status-btn.active i,
            .status-btn.active span {
                color: white;
            }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let updateModal, detailModal;
        let selectedStatus = null;

        document.addEventListener('DOMContentLoaded', function() {
            updateModal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
            detailModal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
        });

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            filterTasks();
        }

        function filterTasks() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const priority = document.getElementById('priorityFilter').value;

            document.querySelectorAll('.task-list-item').forEach(item => {
                const name = item.getAttribute('data-name');
                const itemStatus = item.getAttribute('data-status');
                const itemPriority = item.getAttribute('data-priority');

                const matchSearch = !search || name.includes(search);
                const matchStatus = !status || itemStatus === status;
                const matchPriority = !priority || itemPriority === priority;

                item.style.display = matchSearch && matchStatus && matchPriority ? 'block' : 'none';
            });
        }

        document.getElementById('searchInput')?.addEventListener('input', filterTasks);
        document.getElementById('statusFilter')?.addEventListener('change', filterTasks);
        document.getElementById('priorityFilter')?.addEventListener('change', filterTasks);

        function updateStatusModal(userTaskId, taskName, status, reportLink) {
            document.getElementById('updateUserTaskId').value = userTaskId;
            document.getElementById('updateTaskName').textContent = taskName;
            document.getElementById('updateReportLink').value = reportLink || '';

            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            selectStatus(status);
            updateModal.show();
        }

        function selectStatus(status) {
            selectedStatus = status;
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-status') === status) {
                    btn.classList.add('active');
                }
            });
        }

        async function submitUpdateStatus() {
            const userTaskId = parseInt(document.getElementById('updateUserTaskId').value);
            const reportLink = document.getElementById('updateReportLink').value.trim();

            if (!selectedStatus) {
                Swal.fire('Cảnh báo', 'Vui lòng chọn trạng thái', 'warning');
                return;
            }

            Swal.fire({
                title: 'Đang cập nhật...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch('/Staff/UpdateTaskProgress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userTaskId: userTaskId,
                        status: selectedStatus,
                        reportLink: reportLink || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    updateModal.hide();
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => location.reload());
                } else {
                    Swal.fire('Lỗi', data.message, 'error');
                }
            } catch (error) {
                Swal.fire('Lỗi', 'Có lỗi xảy ra: ' + error.message, 'error');
            }
        }

        async function viewTaskDetail(userTaskId) {
            detailModal.show();

            document.getElementById('taskDetailContent').innerHTML = `
                <div class="tm-loading">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2 tm-text-muted">Đang tải...</p>
                </div>
            `;

            try {
                const response = await fetch(`/Staff/GetTaskDetail?userTaskId=${userTaskId}`);
                const data = await response.json();

                if (data.success) {
                    const task = data.task;

                    let overdueNote = '';
                    if (task.isOverdue && task.status !== 'Completed') {
                        overdueNote = '<span class="tm-badge tm-badge-danger ms-2" style="font-size: 1rem; padding: 0.5rem 1rem;"><i class="fas fa-exclamation-triangle me-2"></i>Đang quá hạn</span>';
                    } else if (task.isCompletedLate) {
                        overdueNote = '<span class="tm-badge tm-badge-warning ms-2" style="font-size: 1rem; padding: 0.5rem 1rem;"><i class="fas fa-exclamation-circle me-2"></i>Hoàn thành muộn</span>';
                    }

                    document.getElementById('detailTaskName').innerHTML = `
                        <i class="fas fa-tasks me-2"></i> ${task.taskName}
                    `;

                    document.getElementById('taskDetailContent').innerHTML = `
                        <div class="mb-4 text-center">
                            <span class="tm-badge tm-badge-${task.statusClass}" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                <i class="fas fa-${task.statusIcon} me-2"></i>${task.statusText}
                            </span>
                            ${overdueNote}
                        </div>

                        <div class="detail-grid">
                            <div class="detail-item">
                                <label><i class="fas fa-tasks me-1"></i> Tên công việc</label>
                                <div class="value">${task.taskName}</div>
                            </div>

                            <div class="detail-item">
                                <label><i class="fas fa-align-left me-1"></i> Mô tả</label>
                                <div class="value">${task.description}</div>
                            </div>

                            <div class="detail-item">
                                <label><i class="fas fa-flag me-1"></i> Độ ưu tiên</label>
                                <div class="value">
                                    <span class="tm-badge tm-badge-${task.priority === 'High' ? 'danger' : task.priority === 'Low' ? 'success' : 'warning'}">
                                        <i class="fas fa-flag me-1"></i> ${task.priority}
                                    </span>
                                </div>
                            </div>

                            ${task.platform !== 'N/A' ? `
                                <div class="detail-item">
                                    <label><i class="fas fa-laptop me-1"></i> Platform</label>
                                    <div class="value">
                                        <span class="tm-badge tm-badge-info">
                                            <i class="fas fa-laptop me-1"></i> ${task.platform}
                                        </span>
                                    </div>
                                </div>
                            ` : ''}

                            ${task.deadline !== 'Không có deadline' ? `
                                <div class="detail-item">
                                    <label><i class="fas fa-calendar-times me-1"></i> Deadline</label>
                                    <div class="value ${task.isOverdue || task.isCompletedLate ? 'text-danger' : ''}">${task.deadline}</div>
                                </div>
                            ` : ''}

                            ${task.createdAt ? `
                                <div class="detail-item">
                                    <label><i class="fas fa-clock me-1"></i> Được giao lúc</label>
                                    <div class="value">${task.createdAt}</div>
                                </div>
                            ` : ''}

                            ${task.updatedAt !== 'Chưa cập nhật' ? `
                                <div class="detail-item">
                                    <label><i class="fas fa-sync-alt me-1"></i> Cập nhật cuối</label>
                                    <div class="value">${task.updatedAt}</div>
                                </div>
                            ` : ''}

                            ${task.reportLink ? `
                                <div class="detail-item">
                                    <label><i class="fas fa-link me-1"></i> Link báo cáo</label>
                                    <div class="value">
                                        <a href="${task.reportLink}" target="_blank" class="text-primary">
                                            <i class="fas fa-external-link-alt me-1"></i> Mở báo cáo
                                        </a>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="tm-divider"></div>
                        <div class="text-center">
                            <button class="btn btn-primary" onclick="detailModal.hide(); updateStatusModal(${task.userTaskId}, '${task.taskName}', '${task.status}', '${task.reportLink || ''}')">
                                <i class="fas fa-edit me-2"></i> Cập nhật trạng thái
                            </button>
                        </div>
                    `;
                } else {
                    document.getElementById('taskDetailContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> ${data.message}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('taskDetailContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Lỗi: ${error.message}
                    </div>
                `;
            }
        }
    </script>
}