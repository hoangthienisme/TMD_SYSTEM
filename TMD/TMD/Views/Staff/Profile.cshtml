@{
    ViewData["Title"] = "Hồ sơ cá nhân";
    var user = ViewBag.User as TMD.Models.User;

    // Tự động chọn Layout dựa trên Role
    Layout = user?.Role?.RoleName?.ToLower() == "admin"
        ? "~/Views/Shared/_Layout.cshtml"
        : "~/Views/Shared/_LayoutStaff.cshtml";
}

<div class="profile-container">
    <div class="row g-4">
        <!-- LEFT SIDEBAR - Profile Card -->
        <div class="col-lg-4">
            <div class="profile-card">
                <div class="profile-card__header">
                    <div class="profile-avatar">
                        @user.FullName?.Substring(0, 1)
                    </div>
                    <h4>@user.FullName</h4>
                    <p class="text-muted">@@@user.Username</p>
                    <div class="profile-badges">
                        <span class="badge badge-role">
                            <i class="fas fa-user-tag"></i> @user.Role?.RoleName
                        </span>
                        @if (user.IsActive == true)
                        {
                            <span class="badge badge-status">
                                <i class="fas fa-check-circle"></i> Hoạt động
                            </span>
                        }
                    </div>
                </div>

                <div class="profile-card__body">
                    <div class="profile-info">
                        <div class="profile-info-item">
                            <i class="fas fa-envelope"></i>
                            <div>
                                <span class="label">Email</span>
                                <span class="value">@(user.Email ?? "Chưa cập nhật")</span>
                            </div>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-phone"></i>
                            <div>
                                <span class="label">Số điện thoại</span>
                                <span class="value">@(user.PhoneNumber ?? "Chưa cập nhật")</span>
                            </div>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-building"></i>
                            <div>
                                <span class="label">Phòng ban</span>
                                <span class="value">@(user.Department?.DepartmentName ?? "Chưa phân công")</span>
                            </div>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-calendar-alt"></i>
                            <div>
                                <span class="label">Ngày tham gia</span>
                                <span class="value">@user.CreatedAt?.ToString("dd/MM/yyyy")</span>
                            </div>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-sign-in-alt"></i>
                            <div>
                                <span class="label">Đăng nhập lần cuối</span>
                                <span class="value">@(user.LastLoginAt?.ToString("dd/MM/yyyy HH:mm") ?? "Chưa có")</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT CONTENT - Edit Forms -->
        <div class="col-lg-8">
            <!-- UPDATE PROFILE FORM -->
            <div class="content-card mb-4">
                <div class="content-card__header">
                    <h5><i class="fas fa-user-edit"></i> Cập nhật thông tin</h5>
                </div>
                <div class="content-card__body">
                    <form id="updateProfileForm">
                        <div class="mb-3">
                            <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" id="fullName" class="form-control" value="@user.FullName" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="email" class="form-control" value="@user.Email" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                            <input type="tel" id="phoneNumber" class="form-control" value="@user.PhoneNumber" />
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Lưu thay đổi
                        </button>
                    </form>
                </div>
            </div>

            <!-- CHANGE PASSWORD FORM -->
            <div class="content-card">
                <div class="content-card__header">
                    <h5><i class="fas fa-key"></i> Đổi mật khẩu</h5>
                </div>
                <div class="content-card__body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label class="form-label">Mật khẩu hiện tại <span class="text-danger">*</span></label>
                            <input type="password" id="currentPassword" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mật khẩu mới <span class="text-danger">*</span></label>
                            <input type="password" id="newPassword" class="form-control" required />
                            <small class="text-muted">Tối thiểu 6 ký tự</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Xác nhận mật khẩu mới <span class="text-danger">*</span></label>
                            <input type="password" id="confirmPassword" class="form-control" required />
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Lưu ý:</strong> Sau khi đổi mật khẩu, bạn sẽ cần đăng nhập lại.
                        </div>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-key"></i> Đổi mật khẩu
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .profile-container {
        padding: 30px;
    }

    /* PROFILE CARD */
    .profile-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .profile-card__header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(10px);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        font-weight: 700;
        margin: 0 auto 15px;
        border: 4px solid rgba(255,255,255,0.3);
    }

    .profile-card__header h4 {
        margin: 0 0 5px 0;
        font-weight: 700;
    }

    .profile-badges {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
    }

    .badge {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .badge-role {
        background: rgba(255,255,255,0.2);
        color: white;
    }

    .badge-status {
        background: #48bb78;
        color: white;
    }

    .profile-card__body {
        padding: 25px;
    }

    .profile-info {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .profile-info-item {
        display: flex;
        gap: 15px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e2e8f0;
    }

        .profile-info-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .profile-info-item i {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f7fafc;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .profile-info-item .label {
            display: block;
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 3px;
        }

        .profile-info-item .value {
            display: block;
            font-weight: 600;
            color: #2d3748;
        }

    /* CONTENT CARDS */
    .content-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .content-card__header {
        padding: 20px 25px;
        border-bottom: 1px solid #e2e8f0;
        background: #f7fafc;
    }

        .content-card__header h5 {
            margin: 0;
            font-weight: 600;
            color: #2d3748;
        }

    .content-card__body {
        padding: 25px;
    }

    .form-label {
        font-weight: 500;
        color: #2d3748;
        margin-bottom: 8px;
    }

    .form-control {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
        }

    .btn {
        padding: 10px 25px;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
    }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

    .btn-danger {
        background: linear-gradient(135deg, #f56565, #e53e3e);
        border: none;
    }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 101, 101, 0.4);
        }

    .alert {
        border-radius: 8px;
        border: none;
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Update Profile
        document.getElementById('updateProfileForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phoneNumber: document.getElementById('phoneNumber').value
            };

            Swal.fire({
                title: 'Đang cập nhật...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch('/Staff/UpdateProfileJson', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire('Thành công!', data.message, 'success').then(() => location.reload());
                } else {
                    Swal.fire('Thất bại', data.message, 'error');
                }
            } catch (error) {
                Swal.fire('Lỗi!', 'Có lỗi xảy ra', 'error');
            }
        });

        // Change Password
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                Swal.fire('Lỗi', 'Mật khẩu xác nhận không khớp', 'error');
                return;
            }

            if (newPassword.length < 6) {
                Swal.fire('Lỗi', 'Mật khẩu phải có ít nhất 6 ký tự', 'error');
                return;
            }

            const result = await Swal.fire({
                title: 'Xác nhận đổi mật khẩu?',
                text: 'Bạn sẽ cần đăng nhập lại sau khi đổi mật khẩu',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Có, đổi mật khẩu!',
                cancelButtonText: 'Hủy'
            });

            if (!result.isConfirmed) return;

            Swal.fire({
                title: 'Đang xử lý...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch('/Staff/ChangePasswordJson', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword,
                        confirmPassword: confirmPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire('Thành công!', data.message, 'success').then(() => {
                        window.location.href = '/Account/Login';
                    });
                } else {
                    Swal.fire('Thất bại', data.message, 'error');
                }
            } catch (error) {
                Swal.fire('Lỗi!', 'Có lỗi xảy ra', 'error');
            }
        });
    </script>
}